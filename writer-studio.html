<!DOCTYPE html>
<html lang="th" class="scroll-smooth">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>‚úçüèª‡∏û‡∏π‡πà‡∏Å‡∏±‡∏ô‡πÑ‡∏ü AI: Ultimate Writer's Studio (Pro)</title>

  <!-- Tailwind CSS CDN -->
  <script src="https://cdn.tailwindcss.com"></script>

  <!-- Google Font: Inter & Noto Sans Thai -->
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&family=Noto+Sans+Thai:wght@300;400;500;600;700&display=swap" rel="stylesheet">

  <!-- Phosphor Icons -->
  <script src="https://unpkg.com/@phosphor-icons/web"></script>

  <!-- Markdown Parser -->
  <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>

  <style>
    /* Typography & Transitions */
    body {
      font-family: 'Inter', 'Noto Sans Thai', sans-serif;
      line-height: 1.7;
      transition: background-color 0.3s, color 0.3s;
    }

    /* Custom Scrollbar */
    ::-webkit-scrollbar { width: 8px; height: 8px; }
    ::-webkit-scrollbar-track { background: #f1f5f9; }
    ::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 4px; }
    ::-webkit-scrollbar-thumb:hover { background: #94a3b8; }

    /* Result Boxes */
    .ai-result-box {
      background-color: #f8fafc;
      border: 1px solid #e2e8f0;
      padding: 20px;
      border-radius: 12px;
      margin-top: 16px;
      min-height: 60px;
      position: relative;
      transition: all 0.3s ease-in-out;
    }
    .ai-result-box:hover { border-color: #cbd5e1; }

    /* Markdown Content Styling */
    .prose h1, .prose h2, .prose h3 { font-weight: 700; margin-top: 1em; margin-bottom: 0.5em; color: #1e293b; }
    .prose p { margin-bottom: 0.8em; color: #334155; }
    .prose ul, .prose ol { margin-left: 1.5em; margin-bottom: 0.8em; list-style-type: disc; }
    .prose strong { color: #0f172a; font-weight: 600; }

    /* Action Buttons */
    .ai-result-box:hover .action-buttons { opacity: 1; }
    .action-buttons {
        position: absolute; top: 10px; right: 10px; display: flex; gap: 5px;
        opacity: 0.5; transition: opacity 0.2s; z-index: 10;
    }
    .action-btn {
        background-color: white; border: 1px solid #e2e8f0; color: #64748b;
        padding: 5px 8px; border-radius: 6px; cursor: pointer;
        font-size: 14px; display: flex; align-items: center; justify-content: center;
        transition: all 0.2s;
    }
    .action-btn:hover { background-color: #f1f5f9; color: #6366f1; transform: scale(1.05); }

    /* Chat Interface */
    .chat-container { height: 400px; overflow-y: auto; display: flex; flex-direction: column; gap: 12px; padding: 16px; background: #f8fafc; border-radius: 12px; border: 1px solid #e2e8f0; }
    .chat-message { max-width: 85%; padding: 10px 14px; border-radius: 12px; font-size: 14px; line-height: 1.5; position: relative; word-wrap: break-word; }
    .chat-user { align-self: flex-end; background: #6366f1; color: white; border-bottom-right-radius: 2px; }
    .chat-ai { align-self: flex-start; background: white; border: 1px solid #e2e8f0; color: #334155; border-bottom-left-radius: 2px; }
    
    /* Floating Action Buttons */
    .fab-container { position: fixed; bottom: 30px; right: 30px; display: flex; flex-direction: column; gap: 10px; z-index: 50; }
    .fab-btn {
        width: 56px; height: 56px; border-radius: 50%;
        background: linear-gradient(135deg, #6366f1, #a855f7);
        color: white; display: flex; align-items: center; justify-content: center;
        box-shadow: 0 4px 15px rgba(99, 102, 241, 0.4); border: none; cursor: pointer;
        transition: transform 0.2s, box-shadow 0.2s;
    }
    .fab-btn:hover { transform: translateY(-2px) scale(1.05); box-shadow: 0 6px 20px rgba(99, 102, 241, 0.5); }
    .speaking { animation: pulse-red 2s infinite; background: #ef4444 !important; }
    @keyframes pulse-red { 0% { box-shadow: 0 0 0 0 rgba(239, 68, 68, 0.7); } 70% { box-shadow: 0 0 0 15px rgba(0,0,0,0); } 100% { box-shadow: 0 0 0 0 rgba(0,0,0,0); } }
    
    .tooltip { position: absolute; right: 70px; background: #1e293b; color: white; padding: 4px 8px; border-radius: 4px; font-size: 12px; opacity: 0; pointer-events: none; transition: opacity 0.2s; white-space: nowrap; top: 50%; transform: translateY(-50%); }
    .fab-btn:hover + .tooltip { opacity: 1; }
    
    input:focus, textarea:focus, select:focus { outline: none; border-color: #6366f1; ring: 2px; box-shadow: 0 0 0 3px rgba(99, 102, 241, 0.2); }
    .gradient-text { background-clip: text; -webkit-background-clip: text; color: transparent; background-image: linear-gradient(to right, #4f46e5, #9333ea, #db2777); }
    .generator-section {
        border-radius: 12px;
        padding: 20px;
        box-shadow: 0 1px 3px 0 rgba(0, 0, 0, 0.05);
    }

    /* Modal Styling */
    .modal-overlay {
        position: fixed; top: 0; left: 0; right: 0; bottom: 0;
        background-color: rgba(15, 23, 42, 0.8);
        display: none; justify-content: center; align-items: center;
        z-index: 100;
        backdrop-filter: blur(5px);
    }
    .modal-content {
        background-color: white; border-radius: 16px;
        padding: 24px; width: 90%; max-width: 500px;
        box-shadow: 0 10px 25px rgba(0, 0, 0, 0.2);
        animation: fadeIn 0.3s ease-out;
    }
    @keyframes fadeIn { from { opacity: 0; transform: translateY(-20px); } to { opacity: 1; transform: translateY(0); } }
    
    /* Footer Link Hover Style */
    .footer-link:hover {
        color: #ffffff; 
        text-decoration: underline;
    }
  </style>
</head>

<body class="bg-slate-50 text-slate-800">

  <!-- Header -->
  <header class="bg-white border-b border-slate-200 sticky top-0 z-40 shadow-sm/50 backdrop-blur-md bg-white/90">
    <div class="max-w-6xl mx-auto px-4 h-16 flex items-center justify-between">
      <div class="flex items-center gap-2">
        <div class="w-8 h-8 rounded-lg bg-gradient-to-br from-indigo-600 to-purple-600 flex items-center justify-center text-white">
          <i class="ph-bold ph-pen-nib"></i>
        </div>
        <span class="text-lg font-bold text-slate-800">‡∏û‡∏π‡πà‡∏Å‡∏±‡∏ô‡πÑ‡∏ü <span class="gradient-text">Ultimate</span></span>
      </div>
      <!-- API Status Indicator -->
      <div id="api-status" class="text-xs font-medium px-3 py-1 rounded-full flex items-center gap-1 transition-colors duration-300">
        <i class="ph-fill ph-circle text-xs"></i>
        <span id="api-status-text">‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö API Key...</span>
      </div>
    </div>
  </header>

  <!-- Main Content -->
  <main class="max-w-6xl mx-auto p-4 md:p-6 space-y-8 pb-32">

    <!-- 1. Visual Studio (Image/Video) -->
    <section class="bg-white rounded-2xl shadow-sm border border-slate-200 overflow-hidden">
        <div class="flex border-b border-slate-100">
            <button id="tab-image" class="flex-1 py-3 px-4 font-semibold text-indigo-600 border-b-2 border-indigo-600 bg-indigo-50/30 flex justify-center gap-2 items-center transition-all">
                <i class="ph ph-image"></i> ‡∏™‡∏ï‡∏π‡∏î‡∏¥‡πÇ‡∏≠‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏†‡∏≤‡∏û
            </button>
            <button id="tab-video" class="flex-1 py-3 px-4 font-medium text-slate-500 hover:bg-slate-50 flex justify-center gap-2 items-center transition-all">
                <i class="ph ph-film-strip"></i> ‡∏™‡∏ï‡∏π‡∏î‡∏¥‡πÇ‡∏≠‡∏ß‡∏¥‡∏î‡∏µ‡πÇ‡∏≠ (Beta)
            </button>
        </div>

        <div class="p-6">
            <!-- Image Gen -->
            <div id="content-image-gen" class="block">
                <div class="flex flex-col md:flex-row gap-6">
                    <div class="w-full md:w-1/3 space-y-4">
                         <div>
                            <label class="text-sm font-semibold text-slate-700 mb-1 block">‡∏Ñ‡∏≥‡∏ö‡∏£‡∏£‡∏¢‡∏≤‡∏¢‡∏†‡∏≤‡∏û (Prompt)</label>
                            <textarea id="image-prompt" rows="4" class="w-full p-3 border border-slate-300 rounded-xl text-sm focus:border-indigo-500" placeholder="‡πÄ‡∏ä‡πà‡∏ô: ‡∏ô‡πâ‡∏≠‡∏á‡∏´‡∏°‡∏≤‡∏ä‡∏¥‡∏ß‡∏≤‡∏ß‡∏≤‡∏Ç‡∏ô‡∏™‡∏µ‡∏Ç‡∏≤‡∏ß‡∏•‡∏≤‡∏¢‡∏î‡∏≥ ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏ô‡∏±‡πà‡∏á‡∏°‡∏≠‡∏á‡∏î‡∏≤‡∏ß‡∏ö‡∏ô‡∏¢‡∏≤‡∏ô‡∏≠‡∏ß‡∏Å‡∏≤‡∏®..."></textarea>
                        </div>
                        <button id="generate-image-btn" class="w-full bg-indigo-600 text-white font-semibold py-2.5 rounded-xl hover:bg-indigo-700 transition-all flex justify-center items-center gap-2 shadow-indigo-200 shadow-lg disabled:opacity-50" disabled>
                            <i class="ph-bold ph-magic-wand"></i> ‡∏ß‡∏≤‡∏î‡∏†‡∏≤‡∏û
                        </button>
                    </div>
                    <div class="w-full md:w-2/3 bg-slate-100 rounded-xl border border-slate-200 min-h-[300px] flex items-center justify-center relative overflow-hidden" id="image-result-area">
                         <div class="text-center text-slate-400">
                             <i class="ph ph-image text-4xl mb-2 opacity-50"></i>
                             <p class="text-sm">‡∏†‡∏≤‡∏û‡∏ú‡∏•‡∏•‡∏±‡∏û‡∏ò‡πå‡∏à‡∏∞‡∏õ‡∏£‡∏≤‡∏Å‡∏è‡∏ó‡∏µ‡πà‡∏ô‡∏µ‡πà</p>
                         </div>
                    </div>
                </div>
            </div>
            <!-- Video Gen -->
            <div id="content-video-gen" class="hidden text-center py-12">
                 <div class="w-20 h-20 bg-slate-100 rounded-full flex items-center justify-center mx-auto mb-4"><i class="ph ph-video-camera text-3xl text-slate-400"></i></div>
                 <h3 class="text-lg font-bold text-slate-700">‡∏ü‡∏µ‡πÄ‡∏à‡∏≠‡∏£‡πå‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏ß‡∏¥‡∏î‡∏µ‡πÇ‡∏≠‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏û‡∏±‡∏í‡∏ô‡∏≤</h3>
                 <p class="text-slate-500 text-sm">‡∏£‡∏∞‡∏ö‡∏ö Image-to-Video ‡∏à‡∏∞‡πÄ‡∏õ‡∏¥‡∏î‡πÉ‡∏´‡πâ‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô‡πÄ‡∏£‡πá‡∏ß‡πÜ ‡∏ô‡∏µ‡πâ‡∏Ñ‡∏£‡∏±‡∏ö</p>
            </div>
        </div>
    </section>

    <!-- 2. Creative Studio (Character & Editor) -->
    <section class="bg-white rounded-2xl shadow-sm border border-slate-200 overflow-hidden relative">
         <div class="absolute top-0 left-0 w-1 h-full bg-gradient-to-b from-pink-500 to-rose-500"></div>
         <div class="flex border-b border-slate-100">
            <button id="tab-char" class="flex-1 py-3 px-4 font-semibold text-pink-600 border-b-2 border-pink-600 bg-pink-50/30 flex justify-center gap-2 items-center transition-all">
                <i class="ph ph-chats-circle"></i> ‡∏Ñ‡∏∏‡∏¢‡∏Å‡∏±‡∏ö‡∏ï‡∏±‡∏ß‡∏•‡∏∞‡∏Ñ‡∏£ (Roleplay)
            </button>
            <button id="tab-editor" class="flex-1 py-3 px-4 font-medium text-slate-500 hover:bg-slate-50 flex justify-center gap-2 items-center transition-all">
                <i class="ph ph-article-medium"></i> ‡∏ö‡∏£‡∏£‡∏ì‡∏≤‡∏ò‡∏¥‡∏Å‡∏≤‡∏£ AI (Editor)
            </button>
        </div>

        <div class="p-6">
            <!-- Character Chat -->
            <div id="content-char" class="block">
                <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
                    <!-- Setup Panel -->
                    <div class="md:col-span-1 space-y-4 p-4 bg-slate-50 rounded-xl border border-slate-200">
                        <h3 class="font-bold text-slate-700 flex items-center gap-2"><i class="ph-fill ph-user-gear text-pink-500"></i> ‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤‡∏ï‡∏±‡∏ß‡∏•‡∏∞‡∏Ñ‡∏£</h3>
                        <div>
                            <label class="text-xs font-semibold text-slate-500">‡∏ä‡∏∑‡πà‡∏≠‡∏ï‡∏±‡∏ß‡∏•‡∏∞‡∏Ñ‡∏£</label>
                            <input type="text" id="char-name" class="w-full p-2 border border-slate-300 rounded-lg text-sm" placeholder="‡πÄ‡∏ä‡πà‡∏ô: ‡πÄ‡∏ä‡∏≠‡∏£‡πå‡∏•‡πá‡∏≠‡∏Ñ ‡πÇ‡∏Æ‡∏•‡πå‡∏°‡∏™‡πå">
                        </div>
                        <div>
                            <label class="text-xs font-semibold text-slate-500">‡∏ô‡∏¥‡∏™‡∏±‡∏¢ / ‡∏ö‡∏ó‡∏ö‡∏≤‡∏ó</label>
                            <textarea id="char-desc" rows="4" class="w-full p-2 border border-slate-300 rounded-lg text-sm" placeholder="‡πÄ‡∏ä‡πà‡∏ô: ‡∏â‡∏•‡∏≤‡∏î‡πÄ‡∏õ‡πá‡∏ô‡∏Å‡∏£‡∏î ‡∏õ‡∏≤‡∏Å‡∏à‡∏±‡∏î ‡∏ä‡∏≠‡∏ö‡∏™‡∏±‡∏á‡πÄ‡∏Å‡∏ï‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î‡πÄ‡∏•‡πá‡∏Å‡πÜ ‡∏ô‡πâ‡∏≠‡∏¢‡πÜ ‡πÄ‡∏¢‡πá‡∏ô‡∏ä‡∏≤‡πÅ‡∏ï‡πà‡πÉ‡∏à‡∏î‡∏µ‡∏•‡∏∂‡∏Å‡πÜ"></textarea>
                        </div>
                        
                        <div class="border-t border-slate-200 pt-4 mt-4">
                            <label class="text-xs font-semibold text-slate-500 mb-2 block">‡πÄ‡∏™‡∏µ‡∏¢‡∏á‡∏û‡∏π‡∏î‡∏ï‡∏±‡∏ß‡∏•‡∏∞‡∏Ñ‡∏£ (Gemini TTS)</label>
                            <select id="char-voice" class="w-full p-2 border border-slate-300 rounded-lg text-sm">
                                <option value="Puck">Puck (‡∏ä‡∏≤‡∏¢/‡∏ô‡∏∏‡πà‡∏°‡∏ô‡∏ß‡∏•)</option>
                                <option value="Kore" selected>Kore (‡∏´‡∏ç‡∏¥‡∏á/‡∏ú‡πà‡∏≠‡∏ô‡∏Ñ‡∏•‡∏≤‡∏¢)</option>
                                <option value="Fenrir">Fenrir (‡∏ä‡∏≤‡∏¢/‡πÄ‡∏Ç‡πâ‡∏°‡∏Ç‡∏£‡∏∂‡∏°)</option>
                                <option value="Aoede">Aoede (‡∏´‡∏ç‡∏¥‡∏á/‡∏™‡∏á‡πà‡∏≤‡∏á‡∏≤‡∏°)</option>
                            </select>
                            <p class="text-xs text-slate-500 mt-1">‡πÉ‡∏ä‡πâ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡πÇ‡∏´‡∏°‡∏î‡∏ï‡∏±‡∏ß‡∏•‡∏∞‡∏Ñ‡∏£‡πÄ‡∏ó‡πà‡∏≤‡∏ô‡∏±‡πâ‡∏ô</p>
                        </div>

                        <button id="char-start-btn" class="w-full bg-pink-600 text-white font-semibold py-2 rounded-lg hover:bg-pink-700 text-sm mt-2 disabled:opacity-50" disabled>‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ö‡∏ó‡∏™‡∏ô‡∏ó‡∏ô‡∏≤</button>
                    </div>
                    <!-- Chat Area -->
                    <div class="md:col-span-2 flex flex-col h-[500px]">
                         <div id="chat-history" class="chat-container flex-1 mb-4">
                             <!-- Messages will appear here -->
                             <div class="text-center text-slate-400 mt-10 text-sm">
                                 <i class="ph ph-chat-dots text-3xl mb-2 opacity-50"></i>
                                 <p>‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤‡∏ï‡∏±‡∏ß‡∏•‡∏∞‡∏Ñ‡∏£‡∏ó‡∏≤‡∏á‡∏ã‡πâ‡∏≤‡∏¢ ‡πÅ‡∏•‡πâ‡∏ß‡∏Å‡∏î‡πÄ‡∏£‡∏¥‡πà‡∏°‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏Ñ‡∏∏‡∏¢‡πÑ‡∏î‡πâ‡πÄ‡∏•‡∏¢</p>
                             </div>
                         </div>
                         <div class="flex gap-2">
                             <input type="text" id="chat-input" class="flex-1 p-3 border border-slate-300 rounded-xl text-sm" placeholder="‡∏û‡∏¥‡∏°‡∏û‡πå‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì..." disabled>
                             <button id="chat-send-btn" class="bg-slate-800 text-white px-5 rounded-xl hover:bg-slate-900 disabled:opacity-50 disabled:cursor-not-allowed" disabled>
                                 <i class="ph-bold ph-paper-plane-right"></i>
                             </button>
                         </div>
                    </div>
                </div>
            </div>

            <!-- AI Editor -->
            <div id="content-editor" class="hidden">
                <div class="space-y-4">
                    <div class="flex justify-between items-center">
                         <h3 class="font-bold text-slate-700 flex items-center gap-2"><i class="ph-fill ph-read-cv-logo text-emerald-500"></i> ‡∏™‡πà‡∏á‡∏ï‡πâ‡∏ô‡∏â‡∏ö‡∏±‡∏ö‡πÉ‡∏´‡πâ ‡∏ö.‡∏Å. ‡∏ï‡∏£‡∏ß‡∏à</h3>
                         <span class="text-xs text-slate-500 bg-slate-100 px-2 py-1 rounded">AI ‡∏à‡∏∞‡∏ß‡∏¥‡πÄ‡∏Ñ‡∏£‡∏≤‡∏∞‡∏´‡πå‡∏à‡∏∏‡∏î‡πÅ‡∏Ç‡πá‡∏á/‡∏à‡∏∏‡∏î‡∏≠‡πà‡∏≠‡∏ô</span>
                    </div>
                    <textarea id="editor-input" rows="6" class="w-full p-4 border border-slate-300 rounded-xl text-sm leading-relaxed" placeholder="‡∏ß‡∏≤‡∏á‡πÄ‡∏ô‡∏∑‡πâ‡∏≠‡∏´‡∏≤‡∏ô‡∏¥‡∏¢‡∏≤‡∏¢ ‡∏´‡∏£‡∏∑‡∏≠‡∏â‡∏≤‡∏Å‡∏ó‡∏µ‡πà‡∏Ñ‡∏∏‡∏ì‡πÄ‡∏Ç‡∏µ‡∏¢‡∏ô‡∏ó‡∏µ‡πà‡∏ô‡∏µ‡πà..."></textarea>
                    <button id="editor-analyze-btn" class="bg-emerald-600 text-white font-semibold py-2.5 px-6 rounded-xl hover:bg-emerald-700 flex items-center gap-2 mx-auto disabled:opacity-50" disabled>
                        <i class="ph-bold ph-magnifying-glass"></i> ‡∏ß‡∏¥‡πÄ‡∏Ñ‡∏£‡∏≤‡∏∞‡∏´‡πå‡∏á‡∏≤‡∏ô‡πÄ‡∏Ç‡∏µ‡∏¢‡∏ô
                    </button>
                    <div id="editor-result" class="ai-result-box hidden">
                        <div class="action-buttons">
                             <button class="action-btn" onclick="speakContent('editor-result-content')"><i class="ph ph-speaker-high"></i></button>
                             <button class="action-btn" onclick="downloadLastAudio()"><i class="ph ph-cloud-arrow-down"></i></button>
                             <button class="action-btn" onclick="copyContent('editor-result-content')"><i class="ph ph-copy"></i></button>
                        </div>
                        <div id="editor-result-content" class="prose prose-sm max-w-none"></div>
                    </div>
                </div>
            </div>
        </div>
    </section>

    <!-- 3. ‡πÇ‡∏Ñ‡∏£‡∏á‡∏™‡∏£‡πâ‡∏≤‡∏á‡πÅ‡∏•‡∏∞‡πÅ‡∏Å‡πà‡∏ô‡πÄ‡∏£‡∏∑‡πà‡∏≠‡∏á (Structure & Core) -->
    <section class="generator-section bg-white border border-slate-200 space-y-4">
        <h2 class="text-lg font-bold text-slate-700 flex items-center gap-2"><i class="ph-bold ph-tree-structure text-blue-600"></i> ‡πÇ‡∏Ñ‡∏£‡∏á‡∏™‡∏£‡πâ‡∏≤‡∏á‡πÅ‡∏•‡∏∞‡πÅ‡∏Å‡πà‡∏ô‡πÄ‡∏£‡∏∑‡πà‡∏≠‡∏á (Structure & Core)</h2>
        <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
            
            <!-- Plot Generator -->
            <div class="bg-slate-50 p-5 rounded-xl shadow-sm border border-slate-100">
                <div class="flex items-center gap-2 mb-4 text-sky-600 font-bold"><i class="ph-fill ph-lightbulb text-xl"></i> ‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏û‡∏•‡πá‡∏≠‡∏ï (Plot)</div>
                <input id="plot-input" class="w-full p-2.5 border border-slate-200 rounded-lg text-sm mb-3" placeholder="‡∏Ñ‡∏µ‡∏¢‡πå‡πÄ‡∏ß‡∏¥‡∏£‡πå‡∏î: ‡∏£‡∏±‡∏Å‡πÅ‡∏£‡∏Å, ‡∏™‡∏∑‡∏ö‡∏™‡∏ß‡∏ô">
                <button id="plot-btn" class="w-full bg-sky-600 text-white py-2 rounded-lg text-sm font-medium hover:bg-sky-700 disabled:opacity-50" disabled>‡∏™‡∏£‡πâ‡∏≤‡∏á‡πÑ‡∏≠‡πÄ‡∏î‡∏µ‡∏¢</button>
                <div id="plot-result" class="ai-result-box hidden p-4 text-sm">
                    <div class="action-buttons">
                        <button class="action-btn" onclick="speakContent('plot-result')"><i class="ph ph-speaker-high"></i></button>
                        <button class="action-btn" onclick="downloadLastAudio()"><i class="ph ph-cloud-arrow-down"></i></button>
                    </div>
                </div>
            </div>

            <!-- Outline Generator (NEW) -->
            <div class="bg-slate-50 p-5 rounded-xl shadow-sm border border-slate-100">
                <div class="flex items-center gap-2 mb-4 text-blue-600 font-bold"><i class="ph-fill ph-list-numbers text-xl"></i> ‡∏™‡∏£‡πâ‡∏≤‡∏á‡πÇ‡∏Ñ‡∏£‡∏á‡∏£‡πà‡∏≤‡∏á (Outline)</div>
                <input id="outline-input" class="w-full p-2.5 border border-slate-200 rounded-lg text-sm mb-3" placeholder="‡∏û‡∏•‡πá‡∏≠‡∏ï‡πÄ‡∏£‡∏∑‡πà‡∏≠‡∏á: ‡πÄ‡∏î‡πá‡∏Å‡∏´‡∏ô‡∏∏‡πà‡∏°‡∏ï‡∏≤‡∏°‡∏´‡∏≤‡πÄ‡∏û‡∏ä‡∏£‡πÉ‡∏ô‡∏õ‡πà‡∏≤‡∏≠‡∏≤‡∏ñ‡∏£‡∏£‡∏û‡πå">
                <button id="outline-btn" class="w-full bg-blue-600 text-white py-2 rounded-lg text-sm font-medium hover:bg-blue-700 disabled:opacity-50" disabled>‡∏™‡∏£‡πâ‡∏≤‡∏á‡πÇ‡∏Ñ‡∏£‡∏á‡∏™‡∏£‡πâ‡∏≤‡∏á</button>
                <div id="outline-result" class="ai-result-box hidden p-4 text-sm">
                    <div class="action-buttons">
                        <button class="action-btn" onclick="speakContent('outline-result')"><i class="ph ph-speaker-high"></i></button>
                        <button class="action-btn" onclick="downloadLastAudio()"><i class="ph ph-cloud-arrow-down"></i></button>
                    </div>
                </div>
            </div>
            
            <!-- World-Building Assistant (NEW) -->
            <div class="bg-slate-50 p-5 rounded-xl shadow-sm border border-slate-100">
                <div class="flex items-center gap-2 mb-4 text-indigo-600 font-bold"><i class="ph-fill ph-globe-hemisphere-east text-xl"></i> ‡∏™‡∏£‡πâ‡∏≤‡∏á‡πÇ‡∏•‡∏Å (World-Build)</div>
                <input id="world-input" class="w-full p-2.5 border border-slate-200 rounded-lg text-sm mb-3" placeholder="‡∏£‡∏∞‡∏ö‡∏ö‡πÄ‡∏ß‡∏ó‡∏°‡∏ô‡∏ï‡∏£‡πå‡∏à‡∏≤‡∏Å‡πÄ‡∏™‡∏µ‡∏¢‡∏á‡πÄ‡∏û‡∏•‡∏á ‡∏´‡∏£‡∏∑‡∏≠ ‡πÄ‡∏°‡∏∑‡∏≠‡∏á‡πÉ‡∏ï‡πâ‡∏ô‡πâ‡∏≥">
                <button id="world-btn" class="w-full bg-indigo-600 text-white py-2 rounded-lg text-sm font-medium hover:bg-indigo-700 disabled:opacity-50" disabled>‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î</button>
                <div id="world-result" class="ai-result-box hidden p-4 text-sm">
                    <div class="action-buttons">
                        <button class="action-btn" onclick="speakContent('world-result')"><i class="ph ph-speaker-high"></i></button>
                        <button class="action-btn" onclick="downloadLastAudio()"><i class="ph ph-cloud-arrow-down"></i></button>
                    </div>
                </div>
            </div>
        </div>
    </section>

    <!-- 4. ‡∏†‡∏≤‡∏©‡∏≤‡πÅ‡∏•‡∏∞‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î (Language & Detail) -->
    <section class="generator-section bg-white border border-slate-200 space-y-4">
        <h2 class="text-lg font-bold text-slate-700 flex items-center gap-2"><i class="ph-bold ph-chats-teardrop text-purple-600"></i> ‡∏†‡∏≤‡∏©‡∏≤‡πÅ‡∏•‡∏∞‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î (Language & Detail)</h2>
        <div class="grid grid-cols-1 md:grid-cols-3 gap-6">

            <!-- Refine Style (Existing) -->
            <div class="bg-slate-50 p-5 rounded-xl shadow-sm border border-slate-100">
                <div class="flex items-center gap-2 mb-4 text-violet-600 font-bold"><i class="ph-fill ph-magic-wand text-xl"></i> ‡πÄ‡∏Å‡∏•‡∏≤‡∏™‡∏≥‡∏ô‡∏ß‡∏ô (Refine)</div>
                <textarea id="refine-input" rows="1" class="w-full p-2.5 border border-slate-200 rounded-lg text-sm mb-3" placeholder="‡∏õ‡∏£‡∏∞‡πÇ‡∏¢‡∏Ñ‡∏ó‡∏µ‡πà‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡πÄ‡∏Å‡∏•‡∏≤..."></textarea>
                <button id="refine-btn" class="w-full bg-violet-600 text-white py-2 rounded-lg text-sm font-medium hover:bg-violet-700 disabled:opacity-50" disabled>‡πÄ‡∏Å‡∏•‡∏≤‡∏†‡∏≤‡∏©‡∏≤</button>
                <div id="refine-result" class="ai-result-box hidden p-4 text-sm italic font-serif text-slate-700">
                    <div class="action-buttons">
                        <button class="action-btn" onclick="speakContent('refine-result')"><i class="ph ph-speaker-high"></i></button>
                        <button class="action-btn" onclick="downloadLastAudio()"><i class="ph ph-cloud-arrow-down"></i></button>
                    </div>
                </div>
            </div>

            <!-- Nomenclature/Name Generator (NEW) -->
            <div class="bg-slate-50 p-5 rounded-xl shadow-sm border border-slate-100">
                <div class="flex items-center gap-2 mb-4 text-fuchsia-600 font-bold"><i class="ph-fill ph-identification-card text-xl"></i> ‡∏ï‡∏±‡πâ‡∏á‡∏ä‡∏∑‡πà‡∏≠ (Name Gen)</div>
                <input id="name-input" class="w-full p-2.5 border border-slate-200 rounded-lg text-sm mb-3" placeholder="‡∏ò‡∏µ‡∏°: ‡∏¢‡∏∏‡∏Ñ‡∏Å‡∏•‡∏≤‡∏á‡∏ç‡∏µ‡πà‡∏õ‡∏∏‡πà‡∏ô ‡∏´‡∏£‡∏∑‡∏≠ ‡πÑ‡∏ã‡πÑ‡∏ü">
                <button id="name-btn" class="w-full bg-fuchsia-600 text-white py-2 rounded-lg text-sm font-medium hover:bg-fuchsia-700 disabled:opacity-50" disabled>‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏ä‡∏∑‡πà‡∏≠</button>
                <div id="name-result" class="ai-result-box hidden p-4 text-sm">
                    <div class="action-buttons">
                        <button class="action-btn" onclick="speakContent('name-result')"><i class="ph ph-speaker-high"></i></button>
                        <button class="action-btn" onclick="downloadLastAudio()"><i class="ph ph-cloud-arrow-down"></i></button>
                    </div>
                </div>
            </div>
            
             <!-- Dialogue Polisher (NEW) -->
            <div class="bg-slate-50 p-5 rounded-xl shadow-sm border border-slate-100">
                <div class="flex items-center gap-2 mb-4 text-pink-600 font-bold"><i class="ph-fill ph-chat-text text-xl"></i> ‡πÄ‡∏Å‡∏•‡∏≤‡∏ö‡∏ó‡∏™‡∏ô‡∏ó‡∏ô‡∏≤</div>
                <textarea id="dialogue-input" rows="1" class="w-full p-2.5 border border-slate-200 rounded-lg text-sm mb-3" placeholder="‡∏ö‡∏ó‡∏û‡∏π‡∏î‡∏ó‡∏µ‡πà‡∏≠‡∏¢‡∏≤‡∏Å‡∏õ‡∏£‡∏±‡∏ö‡∏õ‡∏£‡∏∏‡∏á..."></textarea>
                <button id="dialogue-btn" class="w-full bg-pink-600 text-white py-2 rounded-lg text-sm font-medium hover:bg-pink-700 disabled:opacity-50" disabled>‡∏õ‡∏£‡∏±‡∏ö‡∏õ‡∏£‡∏∏‡∏á‡∏ö‡∏ó‡∏û‡∏π‡∏î</button>
                <div id="dialogue-result" class="ai-result-box hidden p-4 text-sm">
                    <div class="action-buttons">
                        <button class="action-btn" onclick="speakContent('dialogue-result')"><i class="ph ph-speaker-high"></i></button>
                        <button class="action-btn" onclick="downloadLastAudio()"><i class="ph ph-cloud-arrow-down"></i></button>
                    </div>
                </div>
            </div>
        </div>
    </section>

    <!-- 5. Marketing and Sales -->
    <section class="generator-section bg-white border border-slate-200 space-y-4">
        <h2 class="text-lg font-bold text-slate-700 flex items-center gap-2"><i class="ph-bold ph-megaphone text-red-600"></i> ‡∏Å‡∏≤‡∏£‡∏ï‡∏•‡∏≤‡∏î‡πÅ‡∏•‡∏∞‡∏Ñ‡∏≥‡πÇ‡∏õ‡∏£‡∏¢ (Marketing)</h2>
        <div class="grid grid-cols-1 md:grid-cols-1">
             <!-- Marketing (Existing) -->
            <div class="bg-slate-50 p-5 rounded-xl shadow-sm border border-slate-100">
                <div class="flex items-center gap-2 mb-4 text-rose-600 font-bold"><i class="ph-fill ph-book-open-text text-xl"></i> ‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏Ñ‡∏≥‡πÇ‡∏õ‡∏£‡∏¢ (Blurb)</div>
                <textarea id="market-input" rows="1" class="w-full p-2.5 border border-slate-200 rounded-lg text-sm mb-3" placeholder="‡πÄ‡∏£‡∏∑‡πà‡∏≠‡∏á‡∏¢‡πà‡∏≠/‡∏Ñ‡∏≠‡∏ô‡πÄ‡∏ã‡πá‡∏õ‡∏ï‡πå‡∏´‡∏•‡∏±‡∏Å..."></textarea>
                <button id="market-btn" class="w-full bg-rose-600 text-white py-2 rounded-lg text-sm font-medium hover:bg-rose-700 disabled:opacity-50" disabled>‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏Ñ‡∏≥‡πÇ‡∏õ‡∏£‡∏¢</button>
                <div id="market-result" class="ai-result-box hidden p-4 text-sm">
                    <div class="action-buttons">
                        <button class="action-btn" onclick="speakContent('market-result')"><i class="ph ph-speaker-high"></i></button>
                        <button class="action-btn" onclick="downloadLastAudio()"><i class="ph ph-cloud-arrow-down"></i></button>
                    </div>
                </div>
            </div>
        </div>
    </section>

  </main>

  <!-- Floating Buttons -->
  <div class="fab-container">
      <!-- Settings Button (NEW) -->
      <div class="relative group">
          <button id="settings-btn" class="fab-btn bg-slate-700 hover:bg-slate-600 group-hover:scale-110"><i class="ph-bold ph-gear-six text-2xl"></i></button>
          <div class="tooltip">‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤ API Key ‡πÅ‡∏•‡∏∞‡πÄ‡∏™‡∏µ‡∏¢‡∏á‡∏≠‡πà‡∏≤‡∏ô</div>
      </div>
      <!-- Speak Selection Button -->
      <div class="relative group">
          <button onclick="speakSelection()" class="fab-btn group-hover:scale-110"><i class="ph-bold ph-read-cv-logo text-2xl"></i></button>
          <div class="tooltip">‡∏≠‡πà‡∏≤‡∏ô‡∏ó‡∏µ‡πà‡πÄ‡∏•‡∏∑‡∏≠‡∏Å (AI Voice)</div>
      </div>
      <!-- Download Button (NEW) -->
      <div class="relative group">
          <button id="download-fab-btn" onclick="downloadLastAudio()" class="fab-btn bg-emerald-600 hover:bg-emerald-700 group-hover:scale-110"><i class="ph-bold ph-cloud-arrow-down text-2xl"></i></button>
          <div class="tooltip">‡∏î‡∏≤‡∏ß‡∏ô‡πå‡πÇ‡∏´‡∏•‡∏î‡πÄ‡∏™‡∏µ‡∏¢‡∏á‡∏•‡πà‡∏≤‡∏™‡∏∏‡∏î (.wav)</div>
      </div>
      <!-- Stop Button -->
      <div class="relative group">
          <button id="stop-speak-btn" onclick="stopSpeaking()" class="fab-btn bg-red-600 hidden hover:bg-red-700"><i class="ph-bold ph-stop text-2xl"></i></button>
          <div class="tooltip">‡∏´‡∏¢‡∏∏‡∏î‡∏≠‡πà‡∏≤‡∏ô</div>
      </div>
  </div>

  <!-- API Key Modal (UPDATED) -->
  <div id="api-key-modal" class="modal-overlay">
    <div class="modal-content">
        <h2 class="text-xl font-bold text-slate-800 mb-4 flex items-center gap-2"><i class="ph-bold ph-key text-indigo-500"></i> ‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤‡∏£‡∏∞‡∏ö‡∏ö</h2>
        
        <!-- 1. Gemini API Key Setting -->
        <div class="p-3 bg-indigo-50 rounded-lg border border-indigo-200 mb-4">
            <h3 class="font-bold text-sm text-indigo-700 mb-2">1. Gemini API Key (‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö AI)</h3>
            <p class="text-xs text-indigo-600 mb-2">
                 <a href="https://aistudio.google.com/app/api-keys" target="_blank" class="font-bold underline transition-colors">‡∏Ñ‡∏•‡∏¥‡∏Å‡∏ó‡∏µ‡πà‡∏ô‡∏µ‡πà‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏™‡∏£‡πâ‡∏≤‡∏á API Key</a>
            </p>
            <input type="text" id="api-key-input" class="w-full p-2 border border-slate-300 rounded-lg text-sm font-mono tracking-wider" placeholder="‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏ß‡∏≤‡∏á Your-Gemini-API-Key-‡∏ó‡∏µ‡πà‡∏ô‡∏µ‡πà...">
            <div id="modal-status" class="text-xs text-slate-500 mt-2"></div>
        </div>
        
        <!-- 2. Gemini TTS Voice Selection (UPDATED) -->
        <div class="p-3 bg-slate-100 rounded-lg border border-slate-200 mb-6">
            <h3 class="font-bold text-sm text-slate-700 mb-2 flex items-center gap-1"><i class="ph-fill ph-speaker-low text-slate-500"></i> 2. ‡πÄ‡∏™‡∏µ‡∏¢‡∏á‡∏≠‡πà‡∏≤‡∏ô‡∏ó‡∏±‡πà‡∏ß‡πÑ‡∏õ (Gemini TTS)</h3>
            <p class="text-xs text-slate-500 mb-2">‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÄ‡∏™‡∏µ‡∏¢‡∏á‡∏Ñ‡∏∏‡∏ì‡∏†‡∏≤‡∏û‡∏™‡∏π‡∏á‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏≠‡πà‡∏≤‡∏ô‡πÄ‡∏ô‡∏∑‡πâ‡∏≠‡∏´‡∏≤‡πÉ‡∏ô‡∏ä‡πà‡∏≠‡∏á‡∏ú‡∏•‡∏•‡∏±‡∏û‡∏ò‡πå</p>
            <select id="gemini-tts-voice" class="w-full p-2 border border-slate-300 rounded-lg text-sm">
                <option value="Pulcherrima" selected>Pulcherrima (‡∏´‡∏ç‡∏¥‡∏á/‡∏ô‡∏∏‡πà‡∏°‡∏ô‡∏ß‡∏•)</option>
                <option value="Kore">Kore (‡∏´‡∏ç‡∏¥‡∏á/‡∏ú‡πà‡∏≠‡∏ô‡∏Ñ‡∏•‡∏≤‡∏¢)</option>
                <option value="Puck">Puck (‡∏ä‡∏≤‡∏¢/‡∏ô‡∏∏‡πà‡∏°‡∏ô‡∏ß‡∏•)</option>
                <option value="Fenrir">Fenrir (‡∏ä‡∏≤‡∏¢/‡πÄ‡∏Ç‡πâ‡∏°‡∏Ç‡∏£‡∏∂‡∏°)</option>
                <option value="Aoede">Aoede (‡∏´‡∏ç‡∏¥‡∏á/‡∏™‡∏á‡πà‡∏≤‡∏á‡∏≤‡∏°)</option>
                <option value="Zephyr">Zephyr (‡∏ä‡∏≤‡∏¢/‡∏™‡∏î‡πÉ‡∏™)</option>
            </select>
            <p id="tts-status" class="text-xs text-slate-500 mt-2">‡∏Ñ‡∏∏‡∏ì‡∏†‡∏≤‡∏û‡πÄ‡∏™‡∏µ‡∏¢‡∏á‡∏à‡∏∞‡∏Ç‡∏∂‡πâ‡∏ô‡∏≠‡∏¢‡∏π‡πà‡∏Å‡∏±‡∏ö‡∏Ñ‡∏ß‡∏≤‡∏°‡∏¢‡∏≤‡∏ß‡∏Ç‡∏≠‡∏á‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°</p>
        </div>


        <div class="flex justify-end gap-3">
            <button id="close-modal-btn" class="bg-slate-200 text-slate-700 font-semibold py-2 px-4 rounded-lg hover:bg-slate-300 transition-colors">‡∏õ‡∏¥‡∏î</button>
            <button id="save-api-key-btn" class="bg-indigo-600 text-white font-semibold py-2 px-4 rounded-lg hover:bg-indigo-700 transition-colors">‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÅ‡∏•‡∏∞‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ï‡πâ‡∏ô</button>
        </div>
    </div>
  </div>

<!-- ************************************ -->
<!-- ‡∏™‡πà‡∏ß‡∏ô‡∏ó‡πâ‡∏≤‡∏¢‡πÄ‡∏ß‡πá‡∏ö‡πÑ‡∏ã‡∏ï‡πå (Footer Section) ‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ï‡πâ‡∏ô -->
<!-- ************************************ -->
<footer class="bg-slate-900 text-gray-300 py-10 md:py-12">
    <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
        <div class="flex flex-col md:flex-row justify-between items-start md:items-center space-y-8 md:space-y-0">
            
            <!-- ‡∏Ñ‡∏≠‡∏•‡∏±‡∏°‡∏ô‡πå‡∏î‡πâ‡∏≤‡∏ô‡∏ã‡πâ‡∏≤‡∏¢: ‡∏ä‡∏∑‡πà‡∏≠‡πÄ‡∏ß‡πá‡∏ö‡πÑ‡∏ã‡∏ï‡πå‡πÅ‡∏•‡∏∞‡∏•‡∏¥‡∏Ç‡∏™‡∏¥‡∏ó‡∏ò‡∏¥‡πå -->
            <div class="text-center md:text-left">
                <h2 class="text-2xl font-extrabold text-white mb-2">
                    Ultimate Writer Studio
                </h2>
                <p class="text-sm">
                    ‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á‡∏°‡∏∑‡∏≠‡∏Ç‡∏±‡πâ‡∏ô‡∏™‡∏∏‡∏î‡∏¢‡∏≠‡∏î‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏ô‡∏±‡∏Å‡πÄ‡∏Ç‡∏µ‡∏¢‡∏ô‡πÅ‡∏•‡∏∞‡∏ô‡∏±‡∏Å‡∏û‡∏±‡∏í‡∏ô‡∏≤
                </p>
                <p class="text-xs mt-4 opacity-75">
                    &copy; 2025 Ultimate Writer Studio. All rights reserved.
                </p>
            </div>

            <!-- ‡∏Ñ‡∏≠‡∏•‡∏±‡∏°‡∏ô‡πå‡∏î‡πâ‡∏≤‡∏ô‡∏Ç‡∏ß‡∏≤: ‡∏•‡∏¥‡∏á‡∏Å‡πå‡πÅ‡∏•‡∏∞‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ú‡∏π‡πâ‡∏™‡∏£‡πâ‡∏≤‡∏á -->
            <div class="flex flex-col sm:flex-row space-y-6 sm:space-y-0 sm:space-x-12 text-center md:text-right">
                
                <!-- ‡∏™‡πà‡∏ß‡∏ô‡∏•‡∏¥‡∏á‡∏Å‡πå (‡∏ï‡∏±‡∏ß‡∏≠‡∏¢‡πà‡∏≤‡∏á) -->
                <div class="space-y-2">
                    <p class="font-semibold text-white uppercase tracking-wider text-sm mb-2">‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•</p>
                    <a href="#" class="block text-sm text-gray-400 footer-link transition duration-150">‡∏ô‡πÇ‡∏¢‡∏ö‡∏≤‡∏¢‡∏Ñ‡∏ß‡∏≤‡∏°‡πÄ‡∏õ‡πá‡∏ô‡∏™‡πà‡∏ß‡∏ô‡∏ï‡∏±‡∏ß</a>
                    <a href="#" class="block text-sm text-gray-400 footer-link transition duration-150">‡∏Ç‡πâ‡∏≠‡∏Å‡∏≥‡∏´‡∏ô‡∏î‡∏Å‡∏≤‡∏£‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô</a>
                    <a href="#" class="block text-sm text-gray-400 footer-link transition duration-150">‡∏ï‡∏¥‡∏î‡∏ï‡πà‡∏≠‡πÄ‡∏£‡∏≤</a>
                </div>

                <!-- ‡∏™‡πà‡∏ß‡∏ô‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ú‡∏π‡πâ‡∏™‡∏£‡πâ‡∏≤‡∏á -->
                <div class="space-y-2">
                    <p class="font-semibold text-white uppercase tracking-wider text-sm mb-2">‡∏ú‡∏π‡πâ‡∏™‡∏£‡πâ‡∏≤‡∏á</p>
                    <p class="text-base font-medium text-amber-300">
                        ‡∏Å‡∏∏‡πâ‡∏á‡πÄ‡∏ï‡πâ‡∏ô ‡∏ß‡∏ä‡∏¥‡∏î‡∏≤
                    </p>
                    <p class="text-sm text-gray-400">
                        ‡∏ô‡∏±‡∏Å‡∏û‡∏±‡∏í‡∏ô‡∏≤‡πÅ‡∏•‡∏∞‡∏ú‡∏π‡πâ‡∏î‡∏π‡πÅ‡∏•‡∏´‡∏•‡∏±‡∏Å
                    </p>
                </div>
            </div>
        </div>

        <!-- ‡∏™‡πà‡∏ß‡∏ô‡πÄ‡∏™‡∏£‡∏¥‡∏°: ‡πÅ‡∏ñ‡∏ö‡πÅ‡∏ö‡πà‡∏á‡πÅ‡∏•‡∏∞‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÄ‡∏ï‡∏¥‡∏° -->
        <div class="mt-10 pt-6 border-t border-gray-700 text-center">
            <p class="text-xs text-gray-500">
                ‡∏≠‡∏≠‡∏Å‡πÅ‡∏ö‡∏ö‡πÅ‡∏•‡∏∞‡∏û‡∏±‡∏í‡∏ô‡∏≤‡∏î‡πâ‡∏ß‡∏¢‡∏Ñ‡∏ß‡∏≤‡∏°‡∏°‡∏∏‡πà‡∏á‡∏°‡∏±‡πà‡∏ô‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏™‡∏±‡∏á‡∏Ñ‡∏°‡∏ô‡∏±‡∏Å‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏™‡∏£‡∏£‡∏Ñ‡πå
            </p>
        </div>

    </div>
</footer>
<!-- ************************************ -->
<!-- ‡∏™‡πà‡∏ß‡∏ô‡∏ó‡πâ‡∏≤‡∏¢‡πÄ‡∏ß‡πá‡∏ö‡πÑ‡∏ã‡∏ï‡πå (Footer Section) ‡∏™‡∏¥‡πâ‡∏ô‡∏™‡∏∏‡∏î -->
<!-- ************************************ -->

  <!-- Logic -->
  <script type="module">
    // --- Configuration ---
    const API_KEY_STORAGE_KEY = 'gemini_api_key';
    const TTS_VOICE_STORAGE_KEY = 'gemini_tts_voice_name'; 
    const SYSTEM_PROMPT_WRITER = `‡∏Ñ‡∏∏‡∏ì‡∏Ñ‡∏∑‡∏≠ "‡∏û‡∏π‡πà‡∏Å‡∏±‡∏ô‡πÑ‡∏ü" AI ‡∏ô‡∏±‡∏Å‡πÄ‡∏Ç‡∏µ‡∏¢‡∏ô‡∏°‡∏∑‡∏≠‡∏≠‡∏≤‡∏ä‡∏µ‡∏û‡∏ä‡∏≤‡∏ß‡πÑ‡∏ó‡∏¢ ‡πÄ‡∏ä‡∏µ‡πà‡∏¢‡∏ß‡∏ä‡∏≤‡∏ç‡∏Å‡∏≤‡∏£‡πÄ‡∏Ç‡∏µ‡∏¢‡∏ô‡∏ô‡∏¥‡∏¢‡∏≤‡∏¢ ‡∏Å‡∏≤‡∏£‡πÉ‡∏ä‡πâ‡∏†‡∏≤‡∏©‡∏≤‡∏ó‡∏µ‡πà‡∏™‡∏•‡∏∞‡∏™‡∏•‡∏ß‡∏¢ ‡πÅ‡∏•‡∏∞‡∏Ñ‡∏ß‡∏≤‡∏°‡∏Ñ‡∏¥‡∏î‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏™‡∏£‡∏£‡∏Ñ‡πå`;
    const GEMINI_TTS_MODEL = "gemini-2.5-flash-preview-tts"; 
    
    // --- Global State ---
    let apiKey = '';
    let isApiReady = false;
    let selectedGeminiVoice = 'Pulcherrima'; 
    let currentAudio = null; // ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö Audio object ‡∏ó‡∏µ‡πà‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÄ‡∏•‡πà‡∏ô
    let lastGeneratedWavBlob = null; // **NEW: ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡πÄ‡∏Å‡πá‡∏ö‡πÑ‡∏ü‡∏•‡πå‡πÄ‡∏™‡∏µ‡∏¢‡∏á‡∏•‡πà‡∏≤‡∏™‡∏∏‡∏î‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏î‡∏≤‡∏ß‡∏ô‡πå‡πÇ‡∏´‡∏•‡∏î**
    
    // --- API Key Management ---
    function loadApiKey() {
        return localStorage.getItem(API_KEY_STORAGE_KEY) || '';
    }
    
    function loadGeminiVoice() { 
        return localStorage.getItem(TTS_VOICE_STORAGE_KEY) || 'Pulcherrima';
    }

    function saveApiKey(key) {
        localStorage.setItem(API_KEY_STORAGE_KEY, key);
        apiKey = key;
        updateApiStatus();
        updateAllButtonsState();
    }
    
    function saveGeminiVoice(voiceName) { 
        localStorage.setItem(TTS_VOICE_STORAGE_KEY, voiceName);
        selectedGeminiVoice = voiceName;
    }
    
    function updateApiStatus() {
        const statusEl = document.getElementById('api-status');
        const statusText = document.getElementById('api-status-text');
        const allButtons = document.querySelectorAll('button:not(#settings-btn):not(#close-modal-btn):not(#save-api-key-btn)');

        if (apiKey && apiKey.length > 10) {
            isApiReady = true;
            statusEl.className = 'text-xs font-medium px-3 py-1 rounded-full flex items-center gap-1 bg-green-100 text-green-700 transition-colors duration-300';
            statusText.textContent = '‡∏û‡∏£‡πâ‡∏≠‡∏°‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô API Key ‡∏ñ‡∏π‡∏Å‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤‡πÅ‡∏•‡πâ‡∏ß';
            document.getElementById('api-key-input').placeholder = 'API Key ‡∏ñ‡∏π‡∏Å‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÅ‡∏•‡πâ‡∏ß (‡πÑ‡∏°‡πà‡πÅ‡∏™‡∏î‡∏á‡∏Ñ‡πà‡∏≤‡∏à‡∏£‡∏¥‡∏á)';
            allButtons.forEach(btn => btn.disabled = false);
            
            const charStartBtn = document.getElementById('char-start-btn');
            if (charStartBtn) charStartBtn.disabled = false;

        } else {
            isApiReady = false;
            statusEl.className = 'text-xs font-medium px-3 py-1 rounded-full flex items-center gap-1 bg-red-100 text-red-700 transition-colors duration-300';
            statusText.textContent = 'API Key ‡∏´‡∏≤‡∏¢‡πÑ‡∏õ! (‡πÄ‡∏õ‡∏¥‡∏î‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÉ‡∏™‡πà‡∏Ñ‡∏µ‡∏¢‡πå)';
            allButtons.forEach(btn => btn.disabled = true);
            
            document.getElementById('chat-send-btn').disabled = true;
            
            if (!localStorage.getItem(API_KEY_STORAGE_KEY)) {
                setTimeout(() => document.getElementById('api-key-modal').style.display = 'flex', 500);
            }
        }
    }
    
    function updateAllButtonsState() {
        const buttonsToDisable = [
            'generate-image-btn', 'char-start-btn', 'chat-send-btn', 
            'editor-analyze-btn', 'plot-btn', 'outline-btn', 
            'world-btn', 'refine-btn', 'name-btn', 
            'dialogue-btn', 'market-btn'
        ];
        
        buttonsToDisable.forEach(id => {
            const btn = document.getElementById(id);
            if (btn) btn.disabled = !isApiReady;
        });
        
        document.getElementById('chat-input').disabled = !isApiReady;
    }


    // --- Utilities ---
    async function callGemini(prompt, systemPrompt) {
        if (!isApiReady) return "‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤ API Key ‡∏Å‡πà‡∏≠‡∏ô‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô (‡∏õ‡∏∏‡πà‡∏°‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤‡∏°‡∏∏‡∏°‡∏Ç‡∏ß‡∏≤‡∏ö‡∏ô)";
        let retries = 0;
        const maxRetries = 3;
        const url = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-09-2025:generateContent?key=${apiKey}`;

        while (retries < maxRetries) {
            try {
                const res = await fetch(url, {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({
                        contents: [{parts: [{text: prompt}]}],
                        systemInstruction: {parts: [{text: systemPrompt}]}
                    })
                });

                if (res.status === 429) { 
                    retries++;
                    const delay = Math.pow(2, retries) * 1000; 
                    await new Promise(resolve => setTimeout(resolve, delay));
                    continue; 
                }
                
                if (res.status === 400 || res.status === 403 || res.status === 401) {
                    const errorData = await res.json();
                    document.getElementById('api-key-modal').style.display = 'flex';
                    const errorMessage = errorData.error.message || "Unknown error.";
                    document.getElementById('modal-status').innerHTML = `<p class="text-red-500 font-bold">API Key ‡∏≠‡∏≤‡∏à‡πÑ‡∏°‡πà‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á‡∏´‡∏£‡∏∑‡∏≠‡∏´‡∏°‡∏î‡∏≠‡∏≤‡∏¢‡∏∏: ${errorMessage}</p>`;
                    return "‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡∏î‡πâ‡∏≤‡∏ô‡∏Å‡∏≤‡∏£‡∏≠‡∏ô‡∏∏‡∏ç‡∏≤‡∏ï. ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö API Key ‡πÉ‡∏ô‡∏´‡∏ô‡πâ‡∏≤‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤";
                }

                const data = await res.json();
                return data.candidates?.[0]?.content?.parts?.[0]?.text || "‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡∏ó‡∏≤‡∏á‡πÄ‡∏ó‡∏Ñ‡∏ô‡∏¥‡∏Ñ ‡∏´‡∏£‡∏∑‡∏≠‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡∏ß‡πà‡∏≤‡∏á‡πÄ‡∏õ‡∏•‡πà‡∏≤";

            } catch (e) {
                retries++;
                const delay = Math.pow(2, retries) * 1000;
                await new Promise(resolve => setTimeout(resolve, delay));
            }
        }
        return "‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠‡∏Å‡∏±‡∏ö‡πÄ‡∏ã‡∏¥‡∏£‡πå‡∏ü‡πÄ‡∏ß‡∏≠‡∏£‡πå‡πÑ‡∏î‡πâ‡∏´‡∏•‡∏±‡∏á‡∏à‡∏≤‡∏Å‡∏û‡∏¢‡∏≤‡∏¢‡∏≤‡∏°‡∏´‡∏•‡∏≤‡∏¢‡∏Ñ‡∏£‡∏±‡πâ‡∏á";
    }

    async function callImagen(prompt) {
        if (!isApiReady) return null;
        let retries = 0;
        const maxRetries = 3;
        const url = `https://generativelanguage.googleapis.com/v1beta/models/imagen-4.0-generate-001:predict?key=${apiKey}`;

        while (retries < maxRetries) {
            try {
                const res = await fetch(url, {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({ instances: [{ prompt: prompt }], parameters: { sampleCount: 1 } })
                });

                if (res.status === 429) { 
                    retries++;
                    const delay = Math.pow(2, retries) * 1000;
                    await new Promise(resolve => setTimeout(resolve, delay));
                    continue; 
                }
                
                if (res.status === 400 || res.status === 403 || res.status === 401) {
                     document.getElementById('api-key-modal').style.display = 'flex';
                     document.getElementById('modal-status').innerHTML = `<p class="text-red-500 font-bold">API Key ‡∏≠‡∏≤‡∏à‡πÑ‡∏°‡πà‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏™‡∏¥‡∏ó‡∏ò‡∏¥‡πå‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô Imagen ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏Ñ‡∏µ‡∏¢‡πå</p>`;
                     return null;
                 }


                const data = await res.json();
                if(data.predictions?.[0]?.bytesBase64Encoded) return `data:image/png;base64,${data.predictions[0].bytesBase64Encoded}`;
                throw new Error("No Image Data");
            } catch (e) { 
                retries++;
                const delay = Math.pow(2, retries) * 1000;
                await new Promise(resolve => setTimeout(resolve, delay));
            }
        }
        return null; 
    }

    // --- High Quality TTS Function (Gemini 2.5) ---
    async function callGeminiTTS(text, voiceName) {
        if (!isApiReady) { console.error("API Key not set for TTS."); return; }
        lastGeneratedWavBlob = null; // Clear previous audio
        let retries = 0;
        const maxRetries = 3;
        const url = `https://generativelanguage.googleapis.com/v1beta/models/${GEMINI_TTS_MODEL}:generateContent?key=${apiKey}`;

        const payload = {
            contents: [{ parts: [{ text: text }] }],
            generationConfig: {
                responseModalities: ["AUDIO"],
                speechConfig: {
                    voiceConfig: {
                        prebuiltVoiceConfig: { voiceName: voiceName }
                    }
                }
            }
        };

        while (retries < maxRetries) {
            try {
                const response = await fetch(url, {
                    method: "POST",
                    headers: { "Content-Type": "application/json" },
                    body: JSON.stringify(payload)
                });
                
                if (response.status === 429) { 
                    retries++;
                    const delay = Math.pow(2, retries) * 1000; 
                    await new Promise(resolve => setTimeout(resolve, delay));
                    continue; 
                }

                const data = await response.json();
                const base64Audio = data.candidates?.[0]?.content?.parts?.[0]?.inlineData?.data;
                const mimeType = data.candidates?.[0]?.content?.parts?.[0]?.inlineData?.mimeType;
                
                if (base64Audio && mimeType && mimeType.startsWith("audio/L16")) {
                    // Extract sample rate from mimeType if available (default 24000)
                    const rateMatch = mimeType.match(/rate=(\d+)/);
                    const sampleRate = rateMatch ? parseInt(rateMatch[1], 10) : 24000; 
                    
                    const wavBlob = pcmToWavBlob(base64Audio, sampleRate);
                    lastGeneratedWavBlob = wavBlob; // **Save the WAV Blob**
                    playWavBlob(wavBlob); // Play the generated audio
                } else {
                    console.error("No valid audio data returned or invalid mime type:", mimeType);
                }
                return;

            } catch (error) {
                retries++;
                const delay = Math.pow(2, retries) * 1000;
                await new Promise(resolve => setTimeout(resolve, delay));
            }
        }
        console.error("Failed to generate TTS audio after multiple retries.");
    }

    // **NEW FUNCTION: Converts PCM to WAV Blob and returns it**
    function pcmToWavBlob(base64String, sampleRate) {
        const binaryString = atob(base64String);
        const len = binaryString.length;
        const bytes = new Int16Array(len / 2); // Signed 16-bit PCM
        const byteView = new DataView(bytes.buffer);
        
        // Convert binary string to Int16Array, handling little-endian format
        for (let i = 0; i < len; i += 2) {
             const lowByte = binaryString.charCodeAt(i);
             const highByte = binaryString.charCodeAt(i + 1);
             byteView.setInt16(i, lowByte | (highByte << 8), true); 
        }
        
        const wavHeader = createWavHeader(bytes.byteLength, sampleRate, 1, 16);
        
        // Combine header and PCM data
        return new Blob([wavHeader, bytes], { type: 'audio/wav' });
    }

    // **NEW FUNCTION: Plays the WAV Blob**
    function playWavBlob(wavBlob) {
        stopSpeaking(); // Stop previous audio

        const url = URL.createObjectURL(wavBlob);
        
        currentAudio = new Audio(url);
        const stopBtn = document.getElementById('stop-speak-btn');
        
        currentAudio.onplay = () => {
             stopBtn.classList.remove('hidden'); 
             stopBtn.classList.add('speaking');
        };
        currentAudio.onended = () => {
             stopBtn.classList.add('hidden'); 
             stopBtn.classList.remove('speaking');
             URL.revokeObjectURL(url);
        };
        
        const playPromise = currentAudio.play();
        if (playPromise !== undefined) {
            playPromise.catch(error => {
                if (error.name !== "AbortError") {
                    console.error("Audio playback error:", error);
                }
            });
        }
    }

    function createWavHeader(dataLength, sampleRate, numChannels, bitsPerSample) {
        const buffer = new ArrayBuffer(44);
        const view = new DataView(buffer);

        writeString(view, 0, 'RIFF');
        view.setUint32(4, 36 + dataLength, true);
        writeString(view, 8, 'WAVE');
        
        writeString(view, 12, 'fmt ');
        view.setUint32(16, 16, true);
        view.setUint16(20, 1, true); // PCM
        view.setUint16(22, numChannels, true);
        view.setUint32(24, sampleRate, true);
        view.setUint32(28, sampleRate * numChannels * (bitsPerSample / 8), true); // Byte rate
        view.setUint16(32, numChannels * (bitsPerSample / 8), true); // Block align
        view.setUint16(34, bitsPerSample, true);
        
        writeString(view, 36, 'data');
        view.setUint32(40, dataLength, true);

        return new Uint8Array(buffer);
    }

    function writeString(view, offset, string) {
        for (let i = 0; i < string.length; i++) {
            view.setUint8(offset + i, string.charCodeAt(i));
        }
    }

    function loading(el, text="‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏Ñ‡∏¥‡∏î...") {
        el.classList.remove('hidden');
        el.innerHTML = `<div class="flex items-center gap-2 text-slate-500 justify-center py-4"><i class="ph ph-spinner animate-spin text-xl"></i> ${text}</div>`;
    }

    // --- Tab Switching ---
    const setupTabs = (btn1, btn2, content1, content2, colorClass) => {
        const activeClass = `border-${colorClass}-600 text-${colorClass}-600 bg-${colorClass}-50/30`.split(' ');
        const inactiveClass = "text-slate-500 hover:bg-slate-50".split(' ');
        
        btn1.addEventListener('click', () => {
            content1.classList.remove('hidden'); content2.classList.add('hidden');
            btn1.classList.add(...activeClass); btn1.classList.remove(...inactiveClass);
            btn2.classList.remove(...activeClass); btn2.classList.add(...inactiveClass);
        });
        btn2.addEventListener('click', () => {
            content2.classList.remove('hidden'); content1.classList.add('hidden');
            btn2.classList.add(...activeClass); btn2.classList.remove(...inactiveClass);
            btn1.classList.remove(...activeClass); btn1.classList.add(...inactiveClass);
        });
    };
    setupTabs(document.getElementById('tab-image'), document.getElementById('tab-video'), document.getElementById('content-image-gen'), document.getElementById('content-video-gen'), 'indigo');
    setupTabs(document.getElementById('tab-char'), document.getElementById('tab-editor'), document.getElementById('content-char'), document.getElementById('content-editor'), 'pink');

    // --- Features ---

    // 1. Image Gen
    document.getElementById('generate-image-btn').addEventListener('click', async () => {
        const prompt = document.getElementById('image-prompt').value;
        if(!prompt || !isApiReady) return;
        const resultArea = document.getElementById('image-result-area');
        loading(resultArea, "‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏ß‡∏≤‡∏î‡∏†‡∏≤‡∏û...");
        const imgData = await callImagen(prompt);
        if(imgData) {
            resultArea.innerHTML = `<img src="${imgData}" class="h-full w-full object-contain"><a href="${imgData}" download="ai-art.png" class="absolute bottom-4 right-4 bg-white/90 text-indigo-700 px-3 py-1 rounded-full text-xs font-bold shadow hover:bg-white">‡∏î‡∏≤‡∏ß‡∏ô‡πå‡πÇ‡∏´‡∏•‡∏î</a>`;
        } else {
             if (isApiReady) {
                 resultArea.innerHTML = `<div class="text-red-500 flex flex-col items-center"><i class="ph-bold ph-warning text-2xl"></i><p>‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏†‡∏≤‡∏û ‡∏´‡∏£‡∏∑‡∏≠‡∏Ñ‡∏∏‡∏ì‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏™‡∏¥‡∏ó‡∏ò‡∏¥‡πå‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô Imagen</p></div>`;
             } else {
                 resultArea.innerHTML = `<div class="text-red-500 flex flex-col items-center"><i class="ph-bold ph-warning text-2xl"></i><p>‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÉ‡∏™‡πà API Key ‡∏Å‡πà‡∏≠‡∏ô</p></div>`;
             }
        }
    });

    // 2. Character Chat (Pro)
    let charName = "";
    let charDesc = "";
    let charVoice = "Kore"; 
    const chatHistory = document.getElementById('chat-history');
    const chatInput = document.getElementById('chat-input');
    const chatSend = document.getElementById('chat-send-btn');

    document.getElementById('char-start-btn').addEventListener('click', () => {
        if (!isApiReady) return;
        charName = document.getElementById('char-name').value.trim();
        charDesc = document.getElementById('char-desc').value.trim();
        charVoice = document.getElementById('char-voice').value;

        if(!charName || !charDesc) { 
             const messageBox = document.createElement('div');
             messageBox.className = "fixed top-4 right-4 bg-red-500 text-white p-3 rounded-lg shadow-xl text-sm z-50 transition-opacity duration-300";
             messageBox.innerText = "‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÉ‡∏™‡πà‡∏ä‡∏∑‡πà‡∏≠‡πÅ‡∏•‡∏∞‡∏ô‡∏¥‡∏™‡∏±‡∏¢‡∏ï‡∏±‡∏ß‡∏•‡∏∞‡∏Ñ‡∏£‡∏Å‡πà‡∏≠‡∏ô‡∏Ñ‡∏£‡∏±‡∏ö";
             document.body.appendChild(messageBox);
             setTimeout(() => messageBox.remove(), 2000);
             return; 
        }
        
        chatHistory.innerHTML = `<div class="text-center text-slate-400 text-xs my-4">--- ‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ï‡πâ‡∏ô‡∏ö‡∏ó‡∏™‡∏ô‡∏ó‡∏ô‡∏≤‡∏Å‡∏±‡∏ö ${charName} (Voice: ${charVoice}) ---</div>`;
        addMessage("ai", `‡∏™‡∏ß‡∏±‡∏™‡∏î‡∏µ... ‡∏Ç‡πâ‡∏≤‡∏ä‡∏∑‡πà‡∏≠ ${charName} ‡∏°‡∏µ‡∏ò‡∏∏‡∏£‡∏∞‡∏≠‡∏∞‡πÑ‡∏£‡∏Å‡∏±‡∏ö‡∏Ç‡πâ‡∏≤‡∏£‡∏∂?`);
        chatInput.disabled = false; chatSend.disabled = false; chatInput.focus();
    });

    function addMessage(role, text) {
        const div = document.createElement('div');
        div.className = `chat-message ${role === 'user' ? 'chat-user' : 'chat-ai'}`;
        div.innerText = text;
        if(role === 'ai') {
             const spkBtn = document.createElement('button');
             spkBtn.className = "absolute -bottom-5 right-0 text-slate-400 hover:text-pink-600";
             spkBtn.innerHTML = '<i class="ph-bold ph-speaker-high"></i>';
             // Character chat uses its own specific voice setting
             spkBtn.onclick = () => callGeminiTTS(text, charVoice); 
             div.appendChild(spkBtn);
        }
        chatHistory.appendChild(div);
        chatHistory.scrollTop = chatHistory.scrollHeight;
    }

    async function sendChat() {
        const text = chatInput.value.trim();
        if(!text || !isApiReady) return;
        addMessage("user", text);
        chatInput.value = "";
        
        // Add typing indicator
        const loadingDiv = document.createElement('div');
        loadingDiv.className = "chat-message chat-ai opacity-50";
        loadingDiv.innerHTML = '<i class="ph ph-dots-three animate-bounce"></i>';
        chatHistory.appendChild(loadingDiv);
        chatHistory.scrollTop = chatHistory.scrollHeight;
        chatSend.disabled = true;

        const systemPrompt = `‡∏Ñ‡∏∏‡∏ì‡∏Ñ‡∏∑‡∏≠‡∏ï‡∏±‡∏ß‡∏•‡∏∞‡∏Ñ‡∏£‡∏ä‡∏∑‡πà‡∏≠ "${charName}" ‡∏°‡∏µ‡∏ô‡∏¥‡∏™‡∏±‡∏¢‡πÅ‡∏•‡∏∞‡∏ö‡∏ó‡∏ö‡∏≤‡∏ó‡∏Ñ‡∏∑‡∏≠ "${charDesc}" ‡∏à‡∏á‡∏ï‡∏≠‡∏ö‡∏Ñ‡∏≥‡∏ñ‡∏≤‡∏°‡∏Ç‡∏≠‡∏á‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô‡πÇ‡∏î‡∏¢‡∏™‡∏ß‡∏°‡∏ö‡∏ó‡∏ö‡∏≤‡∏ó‡πÄ‡∏õ‡πá‡∏ô‡∏ï‡∏±‡∏ß‡∏•‡∏∞‡∏Ñ‡∏£‡∏ô‡∏µ‡πâ‡∏≠‡∏¢‡πà‡∏≤‡∏á‡∏™‡∏°‡∏ö‡∏π‡∏£‡∏ì‡πå‡πÅ‡∏ö‡∏ö ‡∏´‡πâ‡∏≤‡∏°‡∏´‡∏•‡∏∏‡∏î‡πÅ‡∏Ñ‡∏£‡∏±‡∏Å‡πÄ‡∏ï‡∏≠‡∏£‡πå ‡πÉ‡∏ä‡πâ‡∏†‡∏≤‡∏©‡∏≤‡πÅ‡∏•‡∏∞‡∏ô‡πâ‡∏≥‡πÄ‡∏™‡∏µ‡∏¢‡∏á‡∏ó‡∏µ‡πà‡πÄ‡∏Ç‡πâ‡∏≤‡∏Å‡∏±‡∏ö‡∏ï‡∏±‡∏ß‡∏•‡∏∞‡∏Ñ‡∏£‡∏ó‡∏µ‡πà‡∏™‡∏∏‡∏î`;
        const reply = await callGemini(`‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô‡∏û‡∏π‡∏î‡∏ß‡πà‡∏≤: "${text}" \n(‡∏ï‡∏≠‡∏ö‡∏Å‡∏•‡∏±‡∏ö‡πÉ‡∏ô‡∏ê‡∏≤‡∏ô‡∏∞ ${charName})`, systemPrompt);
        
        chatHistory.removeChild(loadingDiv);
        addMessage("ai", reply);
        chatSend.disabled = false;
    }

    chatSend.addEventListener('click', sendChat);
    chatInput.addEventListener('keypress', (e) => { 
        if(e.key === 'Enter' && !chatSend.disabled) sendChat(); 
    });


    // 3. AI Editor (Critique)
    document.getElementById('editor-analyze-btn').addEventListener('click', async () => {
        if (!isApiReady) return;
        const text = document.getElementById('editor-input').value;
        if(!text) return;
        const resBox = document.getElementById('editor-result');
        loading(resBox, "‡∏ö.‡∏Å. ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏≠‡πà‡∏≤‡∏ô‡∏á‡∏≤‡∏ô‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì...");
        
        const systemPrompt = `‡∏Ñ‡∏∏‡∏ì‡∏Ñ‡∏∑‡∏≠‡∏ö‡∏£‡∏£‡∏ì‡∏≤‡∏ò‡∏¥‡∏Å‡∏≤‡∏£‡∏ô‡∏ß‡∏ô‡∏¥‡∏¢‡∏≤‡∏¢‡∏°‡∏∑‡∏≠‡∏≠‡∏≤‡∏ä‡∏µ‡∏û ‡∏´‡∏ô‡πâ‡∏≤‡∏ó‡∏µ‡πà‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì‡∏Ñ‡∏∑‡∏≠‡∏ß‡∏¥‡∏à‡∏≤‡∏£‡∏ì‡πå‡∏á‡∏≤‡∏ô‡πÄ‡∏Ç‡∏µ‡∏¢‡∏ô‡∏ó‡∏µ‡πà‡πÑ‡∏î‡πâ‡∏£‡∏±‡∏ö‡∏≠‡∏¢‡πà‡∏≤‡∏á‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏™‡∏£‡∏£‡∏Ñ‡πå‡πÅ‡∏•‡∏∞‡∏ï‡∏£‡∏á‡πÑ‡∏õ‡∏ï‡∏£‡∏á‡∏°‡∏≤ ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏ï‡∏≠‡∏ö‡∏Å‡∏•‡∏±‡∏ö‡πÉ‡∏ô‡∏£‡∏π‡∏õ‡πÅ‡∏ö‡∏ö Markdown ‡πÇ‡∏î‡∏¢‡πÅ‡∏ö‡πà‡∏á‡∏´‡∏±‡∏ß‡∏Ç‡πâ‡∏≠‡∏î‡∏±‡∏á‡∏ô‡∏µ‡πâ:
        1. **‡∏à‡∏∏‡∏î‡πÅ‡∏Ç‡πá‡∏á (Strengths):** ‡∏™‡∏¥‡πà‡∏á‡∏ó‡∏µ‡πà‡∏ó‡∏≥‡πÑ‡∏î‡πâ‡∏î‡∏µ‡πÅ‡∏•‡πâ‡∏ß
        2. **‡∏à‡∏∏‡∏î‡∏ó‡∏µ‡πà‡∏Ñ‡∏ß‡∏£‡∏õ‡∏£‡∏±‡∏ö‡∏õ‡∏£‡∏∏‡∏á (Weaknesses):** ‡∏à‡∏∏‡∏î‡∏ó‡∏µ‡πà‡∏¢‡∏±‡∏á‡∏≠‡πà‡∏≠‡∏ô‡∏´‡∏£‡∏∑‡∏≠‡∏ï‡∏¥‡∏î‡∏Ç‡∏±‡∏î
        3. **‡∏Ñ‡∏≥‡πÅ‡∏ô‡∏∞‡∏ô‡∏≥ (Suggestions):** ‡∏ß‡∏¥‡∏ò‡∏µ‡πÅ‡∏Å‡πâ‡∏õ‡∏±‡∏ç‡∏´‡∏≤‡∏´‡∏£‡∏∑‡∏≠‡πÄ‡∏ó‡∏Ñ‡∏ô‡∏¥‡∏Ñ‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÄ‡∏ï‡∏¥‡∏°
        4. **‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô‡∏†‡∏≤‡∏û‡∏£‡∏ß‡∏°:** (X/10)`;
        
        const analysis = await callGemini(text, systemPrompt);
        resBox.classList.remove('hidden');
        resBox.innerHTML = `
             <div class="action-buttons">
                 <button class="action-btn" onclick="speakContent('editor-result-content')"><i class="ph ph-speaker-high"></i></button>
                 <button class="action-btn" onclick="downloadLastAudio()"><i class="ph ph-cloud-arrow-down"></i></button>
                 <button class="action-btn" onclick="copyContent('editor-result-content')"><i class="ph ph-copy"></i></button>
            </div>
            <div id="editor-result-content" class="prose prose-sm max-w-none">${marked.parse(analysis)}</div>
        `;
    });

    // 4. Simple Generators (Expanded)
    const bindGenerator = (btnId, inputId, resultId, prefix) => {
        document.getElementById(btnId).addEventListener('click', async () => {
            if (!isApiReady) return;
            const inp = document.getElementById(inputId).value;
            if(!inp) return;
            const btn = document.getElementById(btnId);
            const res = document.getElementById(resultId);
            
            loading(res);
            btn.disabled = true;

            const text = await callGemini(`${prefix}: ${inp}`, SYSTEM_PROMPT_WRITER);
            
            res.classList.remove('hidden');
            res.innerHTML = `
                <div class="action-buttons">
                    <button class="action-btn" onclick="speakContent('${resultId}')"><i class="ph ph-speaker-high"></i></button>
                    <button class="action-btn" onclick="downloadLastAudio()"><i class="ph ph-cloud-arrow-down"></i></button>
                    <button class="action-btn" onclick="copyContent('${resultId}')"><i class="ph ph-copy"></i></button>
                </div>
                <div class="prose prose-sm max-w-none">${marked.parse(text)}</div>
            `;
            btn.disabled = false;
        });
    }

    // Structure & Core
    bindGenerator('plot-btn', 'plot-input', 'plot-result', '‡∏™‡∏£‡πâ‡∏≤‡∏á‡πÑ‡∏≠‡πÄ‡∏î‡∏µ‡∏¢‡∏û‡∏•‡πá‡∏≠‡∏ï‡∏à‡∏≤‡∏Å‡∏Ñ‡∏µ‡∏¢‡πå‡πÄ‡∏ß‡∏¥‡∏£‡πå‡∏î');
    bindGenerator('outline-btn', 'outline-input', 'outline-result', '‡∏™‡∏£‡πâ‡∏≤‡∏á‡πÇ‡∏Ñ‡∏£‡∏á‡∏£‡πà‡∏≤‡∏á‡∏ö‡∏ó‡∏´‡∏£‡∏∑‡∏≠‡∏â‡∏≤‡∏Å‡∏à‡∏≤‡∏Å‡∏û‡∏•‡πá‡∏≠‡∏ï');
    bindGenerator('world-btn', 'world-input', 'world-result', '‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î‡πÇ‡∏•‡∏Å, ‡∏£‡∏∞‡∏ö‡∏ö‡πÄ‡∏ß‡∏ó‡∏°‡∏ô‡∏ï‡∏£‡πå, ‡∏´‡∏£‡∏∑‡∏≠‡∏™‡∏±‡∏á‡∏Ñ‡∏°‡∏à‡∏≤‡∏Å‡∏Ñ‡∏≠‡∏ô‡πÄ‡∏ã‡πá‡∏õ‡∏ï‡πå');

    // Language & Detail
    bindGenerator('refine-btn', 'refine-input', 'refine-result', '‡πÄ‡∏Å‡∏•‡∏≤‡∏õ‡∏£‡∏∞‡πÇ‡∏¢‡∏Ñ‡∏ô‡∏µ‡πâ‡πÉ‡∏´‡πâ‡∏™‡∏•‡∏∞‡∏™‡∏•‡∏ß‡∏¢');
    bindGenerator('name-btn', 'name-input', 'name-result', '‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏ä‡∏∑‡πà‡∏≠‡∏ï‡∏±‡∏ß‡∏•‡∏∞‡∏Ñ‡∏£ 5 ‡∏ä‡∏∑‡πà‡∏≠ ‡πÅ‡∏•‡∏∞‡∏ä‡∏∑‡πà‡∏≠‡∏™‡∏ñ‡∏≤‡∏ô‡∏ó‡∏µ‡πà 5 ‡∏ä‡∏∑‡πà‡∏≠ ‡πÉ‡∏ô‡∏ò‡∏µ‡∏°');
    bindGenerator('dialogue-btn', 'dialogue-input', 'dialogue-result', '‡∏õ‡∏£‡∏±‡∏ö‡∏õ‡∏£‡∏∏‡∏á‡∏ö‡∏ó‡∏™‡∏ô‡∏ó‡∏ô‡∏≤‡∏ô‡∏µ‡πâ‡πÉ‡∏´‡πâ‡∏ü‡∏±‡∏á‡∏î‡∏π‡πÄ‡∏õ‡πá‡∏ô‡∏ò‡∏£‡∏£‡∏°‡∏ä‡∏≤‡∏ï‡∏¥‡πÅ‡∏•‡∏∞‡πÄ‡∏Ç‡πâ‡∏≤‡∏Å‡∏±‡∏ö‡πÇ‡∏ó‡∏ô‡πÄ‡∏£‡∏∑‡πà‡∏≠‡∏á');

    // Marketing
    bindGenerator('market-btn', 'market-input', 'market-result', '‡πÄ‡∏Ç‡∏µ‡∏¢‡∏ô‡∏Ñ‡∏≥‡πÇ‡∏õ‡∏£‡∏¢‡∏Ç‡∏≤‡∏¢‡∏Ç‡∏≤‡∏¢‡∏ô‡∏¥‡∏¢‡∏≤‡∏¢‡∏à‡∏≤‡∏Å‡πÄ‡∏£‡∏∑‡πà‡∏≠‡∏á‡∏¢‡πà‡∏≠');

    // --- Modal Logic ---
    document.getElementById('settings-btn').addEventListener('click', () => {
        document.getElementById('api-key-modal').style.display = 'flex';
        document.getElementById('api-key-input').value = '';
        document.getElementById('modal-status').textContent = '‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏£‡∏≠‡∏Å‡∏Ñ‡∏µ‡∏¢‡πå‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å';
        
        // Ensure the current saved voice is selected in the modal
        document.getElementById('gemini-tts-voice').value = selectedGeminiVoice;
    });
    
    document.getElementById('close-modal-btn').addEventListener('click', () => {
        document.getElementById('api-key-modal').style.display = 'none';
    });

    document.getElementById('save-api-key-btn').addEventListener('click', () => {
        const inputKey = document.getElementById('api-key-input').value.trim();
        if (inputKey.length > 20) { // Simple validation
            saveApiKey(inputKey);
        } else if (inputKey.length > 0) {
            document.getElementById('modal-status').textContent = '‡∏£‡∏π‡∏õ‡πÅ‡∏ö‡∏ö‡∏Ñ‡∏µ‡∏¢‡πå‡πÑ‡∏°‡πà‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà‡∏Ñ‡∏£‡∏ö‡∏ñ‡πâ‡∏ß‡∏ô';
            document.getElementById('modal-status').className = 'text-xs text-red-500 mb-4 font-semibold';
            return; 
        }

        // Save the currently selected Gemini TTS voice
        saveGeminiVoice(document.getElementById('gemini-tts-voice').value);
        document.getElementById('api-key-modal').style.display = 'none';

    });
    
    // Initialize on load
    window.onload = () => {
        apiKey = loadApiKey();
        selectedGeminiVoice = loadGeminiVoice(); 
        updateApiStatus();
        
        // Ensure the loaded voice is set in the modal when it opens later
        const voiceSelect = document.getElementById('gemini-tts-voice');
        if (voiceSelect) {
            voiceSelect.value = selectedGeminiVoice;
            voiceSelect.onchange = (e) => saveGeminiVoice(e.target.value);
        }
    }


    // --- Global Helpers (UPDATED to use Gemini TTS) ---
    window.stopSpeaking = () => { 
        if(currentAudio) {
            currentAudio.pause();
            currentAudio.currentTime = 0; // Reset
            const url = currentAudio.src;
            URL.revokeObjectURL(url); // Clean up the Blob URL
            currentAudio = null;
        }
        const btn = document.getElementById('stop-speak-btn');
        btn.classList.add('hidden');
        btn.classList.remove('speaking');
        window.speechSynthesis.cancel();
    };

    window.speakContent = (id) => {
        const el = document.getElementById(id);
        if(el) {
            // Extract text from the visible content
            const proseContent = el.querySelector('.prose-sm') || el;
            const textToSpeak = proseContent.innerText;
            if (textToSpeak.trim()) {
                callGeminiTTS(textToSpeak, selectedGeminiVoice); // Use general selected voice
            }
        }
    };
    
    window.speakSelection = () => {
        const sel = window.getSelection().toString();
        if(sel) {
            callGeminiTTS(sel, selectedGeminiVoice); // Use general selected voice
        }
        else {
             const messageBox = document.createElement('div');
             messageBox.className = "fixed top-4 right-4 bg-yellow-500 text-white p-3 rounded-lg shadow-xl text-sm z-50 transition-opacity duration-300";
             messageBox.innerText = "‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Ñ‡∏•‡∏∏‡∏°‡∏î‡∏≥‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡∏Å‡πà‡∏≠‡∏ô‡∏Ñ‡∏£‡∏±‡∏ö";
             document.body.appendChild(messageBox);
             setTimeout(() => messageBox.remove(), 2000);
        }
    }
    
    // **NEW FUNCTION: Download Audio**
    window.downloadLastAudio = () => {
        if (!lastGeneratedWavBlob) {
            const messageBox = document.createElement('div');
            messageBox.className = "fixed top-4 right-4 bg-red-500 text-white p-3 rounded-lg shadow-xl text-sm z-50 transition-opacity duration-300";
            messageBox.innerText = "‡πÑ‡∏°‡πà‡∏°‡∏µ‡πÑ‡∏ü‡∏•‡πå‡πÄ‡∏™‡∏µ‡∏¢‡∏á‡∏•‡πà‡∏≤‡∏™‡∏∏‡∏î‡πÉ‡∏´‡πâ‡∏î‡∏≤‡∏ß‡∏ô‡πå‡πÇ‡∏´‡∏•‡∏î! (‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÉ‡∏ä‡πâ‡∏õ‡∏∏‡πà‡∏°‡∏≠‡πà‡∏≤‡∏ô‡∏Å‡πà‡∏≠‡∏ô)";
            document.body.appendChild(messageBox);
            setTimeout(() => messageBox.remove(), 3000);
            return;
        }

        const url = URL.createObjectURL(lastGeneratedWavBlob);
        const a = document.createElement('a');
        a.style.display = 'none';
        a.href = url;
        a.download = `gemini_tts_${new Date().toISOString().replace(/[:.]/g, '-')}.wav`;
        document.body.appendChild(a);
        a.click();
        window.URL.revokeObjectURL(url);
        a.remove();
        
        const messageBox = document.createElement('div');
        messageBox.className = "fixed top-4 right-4 bg-emerald-500 text-white p-3 rounded-lg shadow-xl text-sm z-50 transition-opacity duration-300";
        messageBox.innerText = "‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏î‡∏≤‡∏ß‡∏ô‡πå‡πÇ‡∏´‡∏•‡∏î‡πÑ‡∏ü‡∏•‡πå‡πÄ‡∏™‡∏µ‡∏¢‡∏á (.wav)...";
        document.body.appendChild(messageBox);
        setTimeout(() => messageBox.remove(), 1500);
    }
    
    window.copyContent = (id) => {
        const el = document.getElementById(id);
        if(el) {
            const proseContent = el.querySelector('.prose-sm') || el;
            navigator.clipboard.writeText(proseContent.innerText).then(() => {
                const messageBox = document.createElement('div');
                messageBox.className = "fixed top-4 right-4 bg-green-500 text-white p-3 rounded-lg shadow-xl text-sm z-50 transition-opacity duration-300";
                messageBox.innerText = "‡∏Ñ‡∏±‡∏î‡∏•‡∏≠‡∏Å‡πÅ‡∏•‡πâ‡∏ß!";
                document.body.appendChild(messageBox);
                setTimeout(() => messageBox.remove(), 1500);
            }).catch(err => {
                 console.error('Could not copy text: ', err);
            });
        }
    }

  </script>
</body>
</html>
