<!DOCTYPE html>
<html lang="th">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>‡∏û‡∏π‡πà‡∏Å‡∏±‡∏ô‡πÄ‡∏á‡∏¥‡∏ô Al - ‡∏ú‡∏π‡πâ‡∏ä‡πà‡∏ß‡∏¢‡∏ô‡∏±‡∏Å‡πÄ‡∏Ç‡∏µ‡∏¢‡∏ô‡∏ô‡∏¥‡∏¢‡∏≤‡∏¢</title>
    <!-- ‡πÇ‡∏´‡∏•‡∏î Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- ‡πÇ‡∏´‡∏•‡∏î‡∏ü‡∏≠‡∏ô‡∏î‡πå Inter, Sarabun, ‡πÅ‡∏•‡∏∞ Noto Sans Thai -->
    <link href="https://fonts.googleapis.com/css?family=Inter:wght@400;500;600;700&family=Sarabun:wght@400;500;600;700&family=Noto+Sans+Thai:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        /* --- ‡∏™‡πÑ‡∏ï‡∏•‡πå‡∏ï‡∏≤‡∏°‡∏Ñ‡∏≥‡∏Ç‡∏≠‡∏Ç‡∏≠‡∏á‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ (‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï) --- */
        /* Apply Inter font with Noto Sans Thai as fallback */
        body {
            font-family: 'Inter', 'Noto Sans Thai', sans-serif;
            line-height: 1.7;
            /* Allow smooth transitions globally for better UX */
            transition: all 0.3s ease-in-out;
            margin: 0;
            padding: 0;
            overflow: hidden;
            /* ‡∏õ‡πâ‡∏≠‡∏á‡∏Å‡∏±‡∏ô scrollbar ‡∏ã‡πâ‡∏≠‡∏ô‡∏Å‡∏±‡∏ô */
        }

        /* Custom style for prompt blocks (Input/Reference) */
        .prompt-block {
            background-color: #f8fafc;
            /* bg-slate-50 */
            border-left: 5px solid #6366f1;
            /* border-indigo-500 */
            padding: 16px;
            border-radius: 12px;
            margin-top: 16px;
            margin-bottom: 16px;
            font-family: 'monospace', 'Noto Sans Thai';
            white-space: pre-wrap;
            position: relative;
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.05);
            /* Soft shadow */
        }

        /* Style for the copy button */
        .copy-btn {
            position: absolute;
            top: 10px;
            right: 10px;
            background-color: #ffffff;
            border: 1px solid #e2e8f0;
            color: #475569;
            padding: 6px 10px;
            border-radius: 8px;
            font-size: 13px;
            cursor: pointer;
            transition: all 0.2s ease-in-out;
            /* Smooth transition for hover/active */
            font-family: 'Inter', 'Noto Sans Thai', sans-serif;
            box-shadow: 0 1px 2px 0 rgba(0, 0, 0, 0.05);
        }

        .copy-btn:hover {
            background-color: #f1f5f9;
            color: #1e293b;
        }

        /* Style for Al Result Boxes - Clean and professional look */
        .ai-result-box {
            background-color: #f0f9ff;
            /* Default */
            border: 1px solid #bae6fd;
            /* Default */
            padding: 20px;
            border-radius: 12px;
            margin-top: 16px;
            min-height: 60px;
            box-shadow: inset 0 1px 3px 0 rgba(0, 0, 0, 0.05);
            transition: all 0.3s ease-in-out;
        }

        /* Enhancing the input focus for better feedback */
        input:focus,
        textarea:focus,
        select:focus {
            outline: none;
            box-shadow: 0 0 0 3px rgba(99, 102, 241, 0.5);
            /* Indigo glow */
            border-color: #6366f1;
        }

        /* Ensure pre-wrap text in results is readable */
        .ai-result-box pre {
            font-family: 'Inter', 'Noto Sans Thai', sans-serif;
            white-space: pre-wrap;
            word-wrap: break-word;
            color: #1e293b;
            /* text-slate-900 */
            line-height: 1.8;
        }

        /* --- ‡∏™‡∏¥‡πâ‡∏ô‡∏™‡∏∏‡∏î‡∏™‡πÑ‡∏ï‡∏•‡πå‡∏ï‡∏≤‡∏°‡∏Ñ‡∏≥‡∏Ç‡∏≠‡∏Ç‡∏≠‡∏á‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ --- */

        /* --- ‡∏™‡πÑ‡∏ï‡∏•‡πå Chat Bubbles ‡πÅ‡∏•‡∏∞ Animation (‡∏õ‡∏£‡∏±‡∏ö‡∏™‡∏µ‡πÉ‡∏´‡πâ‡πÄ‡∏Ç‡πâ‡∏≤‡∏Å‡∏±‡∏ö‡πÇ‡∏ó‡∏ô‡πÉ‡∏´‡∏°‡πà) --- */
        .chat-bubble-ai {
            background-color: #f1f5f9;
            /* Light slate (‡πÄ‡∏Ç‡πâ‡∏≤‡∏Å‡∏±‡∏ö bg-slate-100) */
            color: #1e293b;
            /* Dark slate */
            border-radius: 20px;
            padding: 12px 16px;
            max-width: 80%;
            align-self: flex-start;
            word-wrap: break-word;
            opacity: 0;
            animation: fadeln 0.3s forwards;
            line-height: 1.7;
            /* ‡πÉ‡∏ä‡πâ line-height ‡∏à‡∏≤‡∏Å body */
        }

        .chat-bubble-user {
            background-color: #4f46e5;
            /* Indigo-600 (‡πÅ‡∏ó‡∏ô‡∏™‡∏µ‡∏°‡πà‡∏ß‡∏á‡πÄ‡∏î‡∏¥‡∏°) */
            color: white;
            border-radius: 20px;
            padding: 12px 16px;
            max-width: 80%;
            align-self: flex-end;
            word-wrap: break-word;
            opacity: 0;
            animation: fadeln 0.3s forwards;
            line-height: 1.7;
            /* ‡πÉ‡∏ä‡πâ line-height ‡∏à‡∏≤‡∏Å body */
        }

        @keyframes fadeln {
            from {
                opacity: 0;
                transform: translateY(10px);
            }

            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        /* Loading Indicator (Spinner) */
        .loader {
            border: 4px solid #e2e8f0;
            /* Light grey */
            border-top: 4px solid #6366f1;
            /* Indigo-500 */
            border-radius: 50%;
            width: 24px;
            height: 24px;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            0% {
                transform: rotate(0deg);
            }

            100% {
                transform: rotate(360deg);
            }
        }

        /* ‡∏ã‡πà‡∏≠‡∏ô scrollbar ‡πÅ‡∏ï‡πà‡∏¢‡∏±‡∏á‡∏Ñ‡∏á scroll ‡πÑ‡∏î‡πâ (‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö Quick Prompts) */
        .no-scrollbar::-webkit-scrollbar {
            display: none;
        }

        .no-scrollbar {
            -ms-overflow-style: none;
            /* IE and Edge */
            scrollbar-width: none;
            /* Firefox */
        }

        /* New Style for Grounding Sources (Citations) */
        .grounding-sources {
            margin-top: 10px;
            padding-top: 10px;
            border-top: 1px solid #e5e7eb;
            /* Light gray border */
            font-size: 0.8rem;
            color: #4b5563;
        }

        .grounding-sources a {
            color: #6366f1;
            text-decoration: none;
            font-weight: 500;
        }

        .grounding-sources a:hover {
            text-decoration: underline;
        }
    </style>
</head>

<body class="bg-slate-100 text-slate-800">

    <!-- Loading Overlay (Authentication Screen) -->
    <div id="loading-overlay" class="fixed inset-0 bg-slate-50 flex items-center justify-center flex-col z-50">
        <div class="loader w-12 h-12 mb-4"></div>
        <h2 class="text-xl font-medium text-indigo-700">‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡∏£‡∏∞‡∏ö‡∏ö...</h2>
        <p class="text-slate-500 text-sm mt-2">‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏™‡∏£‡πâ‡∏≤‡∏á‡πÄ‡∏ã‡∏™‡∏ä‡∏±‡∏ô‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô...</p>
    </div>

    <!-- Main App Container (Hidden until Auth Ready) -->
    <div id="main-app-container" class="flex flex-col h-screen hidden">

        <!-- Header: ‡∏™‡πà‡∏ß‡∏ô‡∏´‡∏±‡∏ß‡∏Ç‡∏≠‡∏á‡πÅ‡∏≠‡∏õ -->
        <header class="bg-white shadow-md p-4 flex flex-col sm:flex-row justify-between items-center space-y-2 sm:space-y-0 sm:space-x-4 flex-shrink-0">
            <!-- Title, Model Selector, and API Key Input -->
            <div class="flex flex-col sm:flex-row items-start sm:items-center space-y-2 sm:space-y-0 sm:space-x-3">
                <div class="flex items-center space-x-3 flex-shrink-0">
                    <h1 class="text-xl font-bold text-indigo-700">‡∏û‡∏π‡πà‡∏Å‡∏±‡∏ô‡πÄ‡∏á‡∏¥‡∏ô Al</h1>
                    <select id="model-selector" class="rounded-lg border border-gray-300 p-2 text-sm focus:ring-indigo-500 focus:border-indigo-500">
                        <option value="gemini">Google Gemini</option>
                        <option value="groq">Groq (Llama 3)</option>
                        <option value="deepseek">Deepseek</option>
                        <option value="chatgpt">ChatGPT</option>
                        <option value="qwen">Qwen Al</option>
                    </select>
                </div>
                <!-- API key input and link -->
                <div id="api-key-container" class="w-full sm:w-auto flex items-center space-x-2">
                    <input type="password" id="api-key-input" class="rounded-lg border border-gray-300 p-2 text-sm w-full sm:w-64" placeholder="‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÉ‡∏™‡πà API Key ‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì">
                    <!-- [FIXED] Corrected SVG from PDF -->
                    <a id="api-key-link" href="#" target="_blank" class="text-indigo-600 hover:text-indigo-800 flex-shrink-0 p-1" title="‡πÑ‡∏õ‡∏ó‡∏µ‡πà‡∏´‡∏ô‡πâ‡∏≤‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏£‡∏±‡∏ö API Key">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                            <path stroke-linecap="round" stroke-linejoin="round" d="M10 6H6a2 2 0 00-2 2v10a2 2 0 002 2h10a2 2 0 002-2v-4M14 4h6m0 0v6m0-6L10 14" />
                        </svg>
                    </a>
                </div>
            </div>

            <!-- Context Awareness Display: ‡πÅ‡∏™‡∏î‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÇ‡∏õ‡∏£‡πÄ‡∏à‡∏Ñ & User ID -->
            <div class="flex items-center space-x-4 text-sm text-slate-600">
                <div class="text-xs font-mono bg-slate-200 p-1 rounded-md hidden sm:block" id="user-id-display">
                    <!-- User ID will be inserted here -->
                </div>
                <div>
                    <label for="project-name" class="font-medium">‡πÇ‡∏õ‡∏£‡πÄ‡∏à‡∏Ñ: </label>
                    <input type="text" id="project-name" value="‡∏ô‡∏¥‡∏¢‡∏≤‡∏¢" class="border-b border-gray-300 focus:border-indigo-500 outline-none w-24">
                </div>
                <div>
                    <label for="word-count" class="font-medium">‡∏à‡πç‡∏≤‡∏ô‡∏ß‡∏ô‡∏Ñ‡πà‡∏≤: </label>
                    <input type="number" id="word-count" value="10500" class="border-b border-gray-300 focus:border-indigo-500 outline-none w-16">
                </div>
                <button id="show-notes" class="text-indigo-600 hover:text-indigo-800">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor">
                        <path d="M9 4.804A7.968 7.968 0 005.5 4c-1.255 0-2.443.29-3.5.804v10.392C3.057 14.71 4.245 14 5.5 14c1.255 0 2.443.29 3.5.804V4.804zM11 4.804A7.968 7.968 0 0114.5 4c1.255 0 2.443.29 3.5.804v10.392C16.943 14.71 15.755 14 14.5 14c-1.255 0-2.443.29-3.5.804V4.804z" />
                    </svg>
                </button>
            </div>
        </header>

        <!-- Character Notes Modal (‡∏ã‡πà‡∏≠‡∏ô‡πÑ‡∏ß‡πâ‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ï‡πâ‡∏ô) -->
        <div id="notes-modal" class="fixed inset-0 bg-black bg-opacity-50 z-40 hidden flex items-center justify-center">
            <div class="bg-white rounded-lg shadow-xl p-6 w-11/12 md:w-1/2 max-w-lg">
                <div class="flex justify-between items-center mb-4">
                    <h3 class="text-lg font-medium">‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏ï‡∏±‡∏ß‡∏•‡∏∞‡∏Ñ‡∏£/‡∏û‡∏•‡πá‡∏≠‡∏ï</h3>
                    <button id="close-modal" class="text-gray-500 hover:text-gray-800">&times;</button>
                </div>
                <textarea id="character-notes" class="w-full h-48 border border-gray-300 rounded-lg p-2" placeholder="‡∏à‡∏î‡πÇ‡∏ô‡πâ‡∏î‡∏ï‡∏±‡∏ß‡∏•‡∏∞‡∏Ñ‡∏£‡∏™‡∏≥‡∏Ñ‡∏±‡∏ç ‡∏´‡∏£‡∏∑‡∏≠‡∏à‡∏∏‡∏î‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡∏Ç‡∏≠‡∏á‡∏û‡∏•‡πá‡∏≠‡∏ï..."></textarea>
                <button id="save-notes" class="mt-4 w-full bg-indigo-600 text-white py-1 rounded-lg hover:bg-indigo-500">‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å</button>
            </div>
        </div>

        <!-- Chat Area: ‡∏û‡∏∑‡πâ‡∏ô‡∏ó‡∏µ‡πà‡πÅ‡∏ä‡∏ó -->
        <div id="chat-container" class="flex-grow overflow-y-auto p-4 space-y-4 flex flex-col">
            <!-- ‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡πÅ‡∏ä‡∏ó‡∏à‡∏∞‡∏ñ‡∏π‡∏Å‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏ó‡∏µ‡πà‡∏ô‡∏µ‡πà -->
        </div>

        <!-- Loading Indicator: ‡∏ï‡∏±‡∏ß‡πÇ‡∏´‡∏•‡∏î -->
        <div id="loading-indicator" class="p-4 flex items-center space-x-2 hidden">
            <div class="loader"></div>
            <span class="text-sm text-slate-500">‡∏û‡∏π‡πà‡∏Å‡∏±‡∏ô‡πÄ‡∏á‡∏¥‡∏ô‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏õ‡∏±‡πà‡∏ô‡πÑ‡∏≠‡πÄ‡∏î‡∏µ‡∏¢...</span>
        </div>

        <!-- Al Action Buttons: ‡∏ü‡∏µ‡πÄ‡∏à‡∏≠‡∏£‡πå LLM ‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÄ‡∏î‡∏¥‡∏° -->
        <div class="flex-shrink-0 p-4 bg-white border-t border-gray-200">
            <div class="flex space-x-3 justify-center flex-wrap gap-2">
                <!-- Plot Continuation Button -->
                <button id="continue-plot-btn" class="flex items-center space-x-1 bg-indigo-400 text-white py-1 px-2 rounded-lg font-medium hover:bg-indigo-500 transition-colors shadow-lg shadow-indigo-500/50">
                    <span>‡πÄ‡∏Ç‡∏µ‡∏¢‡∏ô‡∏ï‡πà‡∏≠ / ‡∏â‡∏≤‡∏Å‡∏ñ‡∏±‡∏î‡πÑ‡∏õ</span>
                </button>
                <!-- NEW: Conflict Generator Button -->
                <button id="generate-conflict-btn" class="flex items-center space-x-1 bg-purple-600 text-white py-1 px-2 rounded-lg font-medium hover:bg-purple-700 transition-colors shadow-lg shadow-purple-500/50">
                    <span>‡∏™‡∏£‡πâ‡∏≤‡∏á 3 ‡∏Ñ‡∏ß‡∏≤‡∏°‡∏Ç‡∏±‡∏î‡πÅ‡∏¢‡πâ‡∏á</span>
                </button>
                <!-- Stop Writing Button -->
                <button id="stop-writing-btn" class="flex items-center space-x-1 bg-red-400 text-white py-1 px-2 rounded-lg font-medium hover:bg-red-500 transition-colors shadow-lg shadow-red-500/50" disabled>
                    <span>X ‡∏´‡∏¢‡∏∏‡∏î‡πÄ‡∏Ç‡∏µ‡∏¢‡∏ô</span>
                </button>
                <!-- TTS Button (Reads last Al response) -->
                <button id="tts-btn" class="flex items-center space-x-1 bg-teal-400 text-white py-1 px-2 rounded-lg font-medium hover:bg-teal-500 transition-colors shadow-lg shadow-teal-500/50" disabled>
                    <span>‡∏ü‡∏±‡∏á‡πÄ‡∏™‡∏µ‡∏¢‡∏á‡∏ï‡∏≠‡∏ö‡∏Å‡∏•‡∏±‡∏ö‡∏•‡πà‡∏≤‡∏™‡∏∏‡∏î</span>
                </button>
                <!-- Read Selected Button -->
                <button id="tts-selected-btn" class="flex items-center space-x-1 bg-blue-400 text-white py-1 px-2 rounded-lg font-medium hover:bg-blue-500 transition-colors shadow-lg shadow-blue-500/50">
                    <span>‡∏≠‡πà‡∏≤‡∏ô‡∏ó‡∏µ‡πà‡πÄ‡∏•‡∏∑‡∏≠‡∏Å</span>
                </button>
                <!-- Stop Audio Button -->
                <button id="stop-audio-btn" class="flex items-center space-x-1 bg-amber-400 text-white py-1 px-2 rounded-lg font-medium hover:bg-amber-500 transition-colors shadow-lg shadow-amber-500/50" disabled>
                    <span>‡∏´‡∏¢‡∏∏‡∏î‡πÄ‡∏•‡πà‡∏ô‡πÄ‡∏™‡∏µ‡∏¢‡∏á</span>
                </button>
                <!-- Download Audio Button -->
                <button id="download-audio-btn" class="flex items-center space-x-1 bg-green-400 text-white py-1 px-2 rounded-lg font-medium hover:bg-green-500 transition-colors shadow-lg shadow-green-500/50" disabled>
                    <!-- [FIXED] Replaced broken SVG from PDF with standard download icon -->
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor">
                        <path fill-rule="evenodd" d="M3 17a1 1 0 011-1h12a1 1 0 110 2H4a1 1 0 01-1-1zM6.293 9.293a1 1 0 011.414 0L9 10.586V3a1 1 0 112 0v7.586l1.293-1.293a1 1 0 111.414 1.414l-3 3a1 1 0 01-1.414 0l-3-3a1 1 0 010-1.414z" clip-rule="evenodd" />
                    </svg>
                    <span>‡∏î‡∏≤‡∏ß‡∏ô‡πå‡πÇ‡∏´‡∏•‡∏î (.WAV)</span>
                </button>
                <audio id="audio-player" class="hidden" controls></audio>
            </div>
        </div>

        <!-- Quick Prompts: ‡∏õ‡∏∏‡πà‡∏°‡∏Ñ‡∏≥‡∏ñ‡∏≤‡∏°‡∏î‡πà‡∏ß‡∏ô -->
        <div class="flex-shrink-0 p-2 bg-white border-t border-gray-200">
            <div class="flex space-x-2 overflow-x-auto no-scrollbar">
                <button class="quick-prompt-btn bg-slate-200 text-slate-700 py-1 px-3 rounded-full text-sm hover:bg-slate-300">‡∏ä‡πà‡∏ß‡∏¢‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏û‡∏•‡πá‡∏≠‡∏ï</button>
                <button class="quick-prompt-btn bg-slate-200 text-slate-700 py-1 px-3 rounded-full text-sm hover:bg-slate-300">‡∏Ñ‡∏¥‡∏î‡∏ï‡∏±‡∏ß‡∏•‡∏∞‡∏Ñ‡∏£</button>
                <button class="quick-prompt-btn bg-slate-200 text-slate-700 py-1 px-3 rounded-full text-sm hover:bg-slate-300">‡πÄ‡∏Ç‡∏µ‡∏¢‡∏ô‡∏ö‡∏ó‡∏™‡∏ô‡∏ó‡∏ô‡∏≤</button>
                <button class="quick-prompt-btn bg-slate-200 text-slate-700 py-1 px-3 rounded-full text-sm hover:bg-slate-300">‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏â‡∏≤‡∏Å</button>
                <button class="quick-prompt-btn bg-slate-200 text-slate-700 py-1 px-3 rounded-full text-sm hover:bg-slate-300">‡∏Ç‡∏±‡∏î‡πÄ‡∏Å‡∏•‡∏≤‡∏†‡∏≤‡∏©‡∏≤</button>
                <button class="quick-prompt-btn bg-slate-200 text-slate-700 py-1 px-3 rounded-full text-sm hover:bg-slate-300">‡∏™‡∏£‡∏∏‡∏õ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•: ‡∏Å‡∏≤‡∏£‡∏õ‡∏è‡∏¥‡∏ß‡∏±‡∏ï‡∏¥‡∏≠‡∏∏‡∏ï‡∏™‡∏≤‡∏´‡∏Å‡∏£‡∏£‡∏°‡∏Ñ‡∏£‡∏±‡πâ‡∏á‡∏ó‡∏µ‡πà 4</button>
            </div>
        </div>

        <!-- Input Area: ‡∏û‡∏∑‡πâ‡∏ô‡∏ó‡∏µ‡πà‡∏û‡∏¥‡∏°‡∏û‡πå -->
        <footer class="flex-shrink-0 p-4 bg-white border-t border-gray-200">
            <div class="flex rounded-lg shadow-sm">
                <input type="text" id="user-input" class="flex-grow border-gray-300 border-l border-t border-b rounded-l-lg p-3 focus:outline-none focus:ring-2 focus:ring-indigo-500 focus:border-transparent" placeholder="‡∏Ñ‡∏∏‡∏¢‡∏Å‡∏±‡∏ö '‡∏û‡∏π‡πà‡∏Å‡∏±‡∏ô‡πÄ‡∏á‡∏¥‡∏ô' ‡∏´‡∏£‡∏∑‡∏≠‡∏û‡∏¥‡∏°‡∏û‡πå '‡∏™‡∏£‡∏∏‡∏õ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•: ‡∏´‡∏±‡∏ß‡∏Ç‡πâ‡∏≠' ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏´‡∏≤‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•...">
                <!-- [FIXED] Replaced broken SVG from PDF with standard paper airplane icon -->
                <button id="send-button" class="bg-indigo-600 text-white p-3 rounded-r-lg hover:bg-indigo-700 focus:outline-none focus:ring-2 focus:ring-indigo-500">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                        <path stroke-linecap="round" stroke-linejoin="round" d="M2 21l21-9L2 3v7l15 2-15 2v7z" />
                    </svg>
                </button>
            </div>
        </footer>
    </div>

    <script type="module">
        // --- Firebase Imports ---
        import {
            initializeApp
        } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import {
            getAuth,
            signInAnonymously,
            signInWithCustomToken,
            onAuthStateChanged
        } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import {
            getFirestore,
            setLogLevel
        } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // --- Firebase Globals ---
        let db;
        let auth;
        let userId = null;
        let isAuthReady = false; // Flag to ensure chat doesn't start before auth

        // --- ‡∏™‡πà‡∏ß‡∏ô‡∏Ç‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤ API ---
        const GEMINI_API_URL_BASE = 'https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-09-2025:generateContent?key=';
        const TTS_API_URL_BASE = 'https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-tts:generateContent?key=';
        const GEMINI_MODEL_NAME = "gemini-2.5-flash-preview-09-2025";
        const TTS_MODEL_NAME = "gemini-2.5-flash-preview-tts"; // Model used in payload
        const GROUNDING_PREFIX = '‡∏™‡∏£‡∏∏‡∏õ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•:';
        // [FIXED] Added missing system prompt for grounding
        const GROUNDING_SYSTEM_PROMPT = "‡∏Ñ‡∏∏‡∏ì‡πÄ‡∏õ‡πá‡∏ô‡∏ú‡∏π‡πâ‡∏ä‡πà‡∏ß‡∏¢ AI ‡∏ó‡∏µ‡πà‡∏°‡∏µ‡∏õ‡∏£‡∏∞‡πÇ‡∏¢‡∏ä‡∏ô‡πå ‡∏™‡∏£‡∏∏‡∏õ‡∏ú‡∏•‡∏Å‡∏≤‡∏£‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤‡πÅ‡∏•‡∏∞‡∏ï‡∏≠‡∏ö‡∏Ñ‡∏≥‡∏ñ‡∏≤‡∏°‡∏Ç‡∏≠‡∏á‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ‡πÄ‡∏õ‡πá‡∏ô‡∏†‡∏≤‡∏©‡∏≤‡πÑ‡∏ó‡∏¢‡∏≠‡∏¢‡πà‡∏≤‡∏á‡∏Å‡∏£‡∏∞‡∏ä‡∏±‡∏ö‡πÅ‡∏•‡∏∞‡∏ä‡∏±‡∏î‡πÄ‡∏à‡∏ô";

        // --- System Prompt ‡∏Ç‡∏≠‡∏á "‡∏û‡∏π‡πà‡∏Å‡∏±‡∏ô‡πÄ‡∏á‡∏¥‡∏ô" ---
        const SYSTEM_PROMPT = `‡∏Ñ‡∏∏‡∏ì‡∏Ñ‡∏∑‡∏≠ Al ‡∏ô‡∏±‡∏Å‡πÄ‡∏Ç‡∏µ‡∏¢‡∏ô‡∏ä‡∏≤‡∏ß‡πÑ‡∏ó‡∏¢‡∏°‡∏∑‡∏≠‡∏≠‡∏≤‡∏ä‡∏µ‡∏û ‡∏ô‡∏≤‡∏°‡∏õ‡∏≤‡∏Å‡∏Å‡∏≤‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì‡∏Ñ‡∏∑‡∏≠ (‡∏û‡∏π‡πà‡∏Å‡∏±‡∏ô‡πÄ‡∏á‡∏¥‡∏ô) ‡∏ã‡∏∂‡πà‡∏á‡πÉ‡∏Ñ‡∏£‡∏ï‡πà‡∏≠‡πÉ‡∏Ñ‡∏£‡∏ï‡πà‡∏≤‡∏á‡∏Ç‡∏ô‡∏≤‡∏ô‡∏ô‡∏≤‡∏°‡∏Ñ‡∏∏‡∏ì‡∏ß‡πà‡∏≤‡∏≠‡∏±‡∏à‡∏â‡∏£‡∏¥‡∏¢‡∏∞‡∏î‡πâ‡∏≤‡∏ô‡∏á‡∏≤‡∏ô‡πÄ‡∏Ç‡∏µ‡∏¢‡∏ô (‡πÑ‡∏≠‡πÄ‡∏î‡∏µ‡∏¢‡πÄ‡∏õ‡πá‡∏ô‡πÄ‡∏•‡∏¥‡∏®) ‡∏Ñ‡∏∏‡∏ì‡∏°‡∏µ‡∏õ‡∏£‡∏∞‡∏™‡∏ö‡∏Å‡∏≤‡∏£‡∏ì‡πå ‡πÉ‡∏ô‡∏î‡πâ‡∏≤‡∏ô‡∏Å‡∏≤‡∏£‡πÄ‡∏Ç‡∏µ‡∏¢‡∏ô‡∏°‡∏≤‡∏Å‡∏ß‡πà‡∏≤ 15 ‡∏õ‡∏µ ‡∏°‡∏µ‡∏ú‡∏•‡∏á‡∏≤‡∏ô‡πÇ‡∏î‡∏î‡πÄ‡∏î‡πà‡∏ô‡πÉ‡∏ô‡∏î‡πâ‡∏≤‡∏ô‡∏á‡∏≤‡∏ô‡πÄ‡∏Ç‡∏µ‡∏¢‡∏ô‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó‡∏ô‡∏¥‡∏¢‡∏≤‡∏¢ ‡∏Ñ‡∏∏‡∏ì‡∏°‡∏µ‡∏Ñ‡∏ß‡∏≤‡∏°‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡πÉ‡∏ô‡∏Å‡∏≤‡∏£ ‡πÄ‡∏Ç‡∏µ‡∏¢‡∏ô‡πÄ‡∏£‡∏∑‡πà‡∏≠‡∏á‡∏£‡∏≤‡∏ß‡∏≠‡∏±‡∏ô‡∏ô‡πà‡∏≤‡∏ï‡∏∑‡πà‡∏ô‡πÄ‡∏ï‡πâ‡∏ô ‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏™‡∏£‡∏£‡∏Ñ‡πå‡∏ï‡∏±‡∏ß‡∏•‡∏∞‡∏Ñ‡∏£‡∏ó‡∏µ‡πà‡∏°‡∏µ‡πÄ‡∏™‡∏ô‡πà‡∏´‡πå ‡πÅ‡∏•‡∏∞‡∏û‡∏£‡∏£‡∏ì‡∏ô‡∏≤‡∏≠‡∏≤‡∏£‡∏°‡∏ì‡πå‡∏Ñ‡∏ß‡∏≤‡∏°‡∏£‡∏π‡πâ‡∏™‡∏∂‡∏Å‡∏Ç‡∏≠‡∏á‡∏ï‡∏±‡∏ß‡∏•‡∏∞‡∏Ñ‡∏£‡πÑ‡∏î‡πâ ‡∏≠‡∏¢‡πà‡∏≤‡∏á‡∏•‡∏∂‡∏Å‡∏ã‡∏∂‡πâ‡∏á ‡∏Ñ‡∏∏‡∏ì‡πÄ‡∏Ç‡πâ‡∏≤‡πÉ‡∏à‡πÇ‡∏Ñ‡∏£‡∏á‡∏™‡∏£‡πâ‡∏≤‡∏á‡πÄ‡∏£‡∏∑‡πà‡∏≠‡∏á‡∏£‡∏≤‡∏ß‡πÅ‡∏•‡∏∞‡∏à‡∏±‡∏á‡∏´‡∏ß‡∏∞‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡πÄ‡∏•‡πà‡∏≤‡πÄ‡∏£‡∏∑‡πà‡∏≠‡∏á ‡∏Ñ‡∏∏‡∏ì‡∏¢‡∏±‡∏á‡∏°‡∏µ‡∏Ñ‡∏ß‡∏≤‡∏°‡πÄ‡∏ä‡∏µ‡πà‡∏¢‡∏ß‡∏ä‡∏≤‡∏ç‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡πÉ‡∏ä‡πâ ‡∏†‡∏≤‡∏©‡∏≤‡πÑ‡∏ó‡∏¢‡πÑ‡∏î‡πâ‡∏≠‡∏¢‡πà‡∏≤‡∏á‡∏î‡∏µ‡πÄ‡∏¢‡∏µ‡πà‡∏¢‡∏°‡πÅ‡∏•‡∏∞‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÉ‡∏ä‡πâ‡∏Ñ‡∏≥‡∏´‡∏£‡∏∑‡∏≠‡∏™‡∏≥‡∏ô‡∏ß‡∏ô‡∏ó‡∏µ‡πà‡πÄ‡∏´‡∏°‡∏≤‡∏∞‡∏Å‡∏±‡∏ö‡∏î‡∏£‡∏á‡∏Å‡∏±‡∏ö‡∏¢‡∏∏‡∏Ñ‡∏™‡∏°‡∏±‡∏¢‡∏Ç‡∏≠‡∏á‡πÄ‡∏£‡∏∑‡πà‡∏≠‡∏á‡∏ô‡∏±‡πâ‡∏ô‡πÜ‡∏ã‡∏∂‡πà‡∏á‡πÄ‡∏õ‡πá‡∏ô‡∏à‡∏∏‡∏î ‡πÅ‡∏Ç‡πá‡∏á‡∏ó‡∏µ‡πà‡∏ó‡∏≥‡πÉ‡∏´‡πâ‡∏á‡∏≤‡∏ô‡πÄ‡∏Ç‡∏µ‡∏¢‡∏ô‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì‡∏Ñ‡∏£‡∏≠‡∏á‡πÉ‡∏à‡∏ú‡∏π‡πâ‡∏≠‡πà‡∏≤‡∏ô‡πÑ‡∏î‡πâ‡∏ó‡∏∏‡∏Å‡πÅ‡∏ô‡∏ß. ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏™‡πà‡∏ß‡∏ô‡∏ï‡∏±‡∏ß‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì ‡∏Ñ‡∏∏‡∏ì‡πÄ‡∏õ‡πá‡∏ô‡∏Ñ‡∏ô‡πÄ‡∏Å‡πà‡∏á‡∏â‡∏•‡∏≤‡∏î‡∏ó‡∏µ‡πà‡∏°‡∏µ ‡πÄ‡∏™‡∏ô‡πà‡∏´‡πå‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡∏û‡∏π‡∏î‡∏Ñ‡∏∏‡∏¢ ‡πÉ‡∏ä‡πâ‡∏†‡∏≤‡∏©‡∏≤‡∏ó‡∏µ‡πà‡∏≠‡∏≤‡∏£‡∏°‡∏ì‡πå‡∏î‡∏µ ‡πÄ‡∏¢‡πà‡∏≤‡∏´‡∏¢‡∏≠‡∏Å ‡∏û‡∏π‡∏î‡πÅ‡∏ã‡∏ß ‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô‡πÑ‡∏î‡πâ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÉ‡∏´‡πâ‡πÄ‡∏Å‡∏¥‡∏î‡∏Ñ‡∏ß‡∏≤‡∏°‡πÑ‡∏ß‡πâ‡πÉ‡∏à‡πÅ‡∏•‡∏∞‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠ ‡∏Å‡∏±‡∏ô‡πÑ‡∏î‡πâ‡∏î‡∏µ‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡∏ó‡∏≥‡∏á‡∏≤‡∏ô‡∏£‡πà‡∏ß‡∏°‡∏Å‡∏±‡∏ô. ‡∏à‡∏∏‡∏î‡∏™‡∏≥‡∏Ñ‡∏±‡∏ç‡∏ó‡∏µ‡πà‡∏Ñ‡∏∏‡∏ì‡∏ï‡πâ‡∏≠‡∏á‡∏£‡∏π‡πâ‡∏Ñ‡∏∑‡∏≠ ‡∏Ñ‡∏∏‡∏ì‡∏à‡∏∞‡πÉ‡∏ä‡πâ‡∏†‡∏≤‡∏©‡∏≤‡∏õ‡∏±‡∏à‡∏à‡∏∏‡∏ö‡∏±‡∏ô‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡∏™‡∏ô‡∏ó‡∏ô‡∏≤‡πÇ‡∏ï‡πâ‡∏ï‡∏≠‡∏ö‡∏Å‡∏±‡∏ö‡∏ô‡∏±‡∏Å ‡πÄ‡∏Ç‡∏µ‡∏¢‡∏ô ‡∏´‡πâ‡∏≤‡∏°‡πÉ‡∏ä‡πâ‡∏Ñ‡πà‡∏≤ ‡∏ó‡πà‡∏≤‡∏ô‡∏ú‡∏π‡πâ‡πÄ‡∏à‡∏£‡∏¥‡∏ç!, ‡∏ô‡∏±‡∏Å‡πÄ‡∏Ç‡∏µ‡∏¢‡∏ô‡∏ó‡πà‡∏≤‡∏ô ‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡∏û‡∏π‡∏î‡∏Ñ‡∏∏‡∏¢‡πÄ‡∏û‡∏£‡∏≤‡∏∞‡∏Ñ‡∏ô‡∏õ‡∏±‡∏à‡∏à‡∏∏‡∏ö‡∏±‡∏ô‡πÑ‡∏°‡πà‡πÉ‡∏ä‡πâ‡∏Å‡∏±‡∏ô. ‡∏Ñ‡∏∏‡∏ì‡∏≠‡∏≤‡∏à‡∏à‡∏∞‡∏ñ‡∏≤‡∏°‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏â‡∏±‡∏ô‡∏´‡∏£‡∏∑‡∏≠‡∏â‡∏±‡∏ô‡∏ö‡∏≠‡∏Å‡πÄ‡∏•‡πà‡∏≤‡∏™‡πÑ‡∏ï‡∏•‡πå‡∏Å‡∏≤‡∏£‡πÄ‡∏Ç‡∏µ‡∏¢‡∏ô‡∏ó‡∏µ‡πà‡∏â‡∏±‡∏ô‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£ ‡πÄ‡∏ä‡πà‡∏ô ‡∏Å‡∏≤‡∏£‡πÄ‡∏•‡πà‡∏≤‡πÄ‡∏£‡∏∑‡πà‡∏≠‡∏á‡πÅ‡∏ö‡∏ö‡∏ï‡∏£‡∏á‡πÑ‡∏õ‡∏ï‡∏£‡∏á ‡∏°‡∏≤, ‡∏Å‡∏≤‡∏£‡πÄ‡∏•‡πà‡∏≤‡πÄ‡∏£‡∏∑‡πà‡∏≠‡∏á‡πÅ‡∏ö‡∏ö‡∏¢‡πâ‡∏≠‡∏ô‡∏≠‡∏î‡∏µ‡∏ï, ‡∏Å‡∏≤‡∏£‡πÄ‡∏•‡πà‡∏≤‡πÄ‡∏£‡∏∑‡πà‡∏≠‡∏á‡πÅ‡∏ö‡∏ö‡∏°‡∏µ‡∏ä‡∏±‡πâ‡∏ô‡πÄ‡∏ä‡∏¥‡∏á, ‡∏™‡∏ô‡∏∏‡∏Å‡∏ï‡∏∑‡πà‡∏ô‡πÄ‡∏ï‡πâ‡∏ô‡πÅ‡∏•‡∏∞‡∏ô‡πà‡∏≤‡∏ï‡∏¥‡∏î‡∏ï‡∏≤‡∏°, ‡πÉ‡∏´‡πâ‡∏ï‡∏±‡∏ß‡∏≠‡∏¢‡πà‡∏≤‡∏á‡∏Ç‡∏≠‡∏á ‡∏ö‡∏ó‡πÄ‡∏Ç‡∏µ‡∏¢‡∏ô‡∏ó‡∏µ‡πà‡∏î‡∏µ‡∏ó‡∏µ‡πà‡∏™‡∏∏‡∏î‡πÄ‡∏°‡∏∑‡πà‡∏≠‡∏â‡∏±‡∏ô‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£.`;

        const CONFLICT_GENERATOR_PROMPT = (notes) => `‡πÉ‡∏ä‡πâ‡∏ö‡∏£‡∏¥‡∏ö‡∏ó‡∏Å‡∏≤‡∏£‡∏™‡∏ô‡∏ó‡∏ô‡∏≤‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î‡πÅ‡∏•‡∏∞ ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏ï‡∏±‡∏ß‡∏•‡∏∞‡∏Ñ‡∏£/‡∏û‡∏•‡πá‡∏≠‡∏î‡∏ó‡∏µ‡πà‡πÅ‡∏ô‡∏ö‡∏°‡∏≤ (‡∏ñ‡πâ‡∏≤‡∏°‡∏µ) ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏™‡∏£‡πâ‡∏≤‡∏á‡πÑ‡∏≠‡πÄ‡∏î‡∏µ‡∏¢ '‡∏Ñ‡∏ß‡∏≤‡∏°‡∏Ç‡∏±‡∏î‡πÅ‡∏¢‡πâ‡∏á‡∏´‡∏•‡∏±‡∏Å' ‡∏ó‡∏µ‡πà‡∏ô‡πà‡∏≤‡∏™‡∏ô‡πÉ‡∏à‡πÅ‡∏•‡∏∞‡πÅ‡∏ï‡∏Å‡∏ï‡πà‡∏≤‡∏á‡∏Å‡∏±‡∏ô ‡∏à‡πç‡∏≤‡∏ô‡∏ß‡∏ô 3 ‡∏£‡∏π‡∏õ‡πÅ‡∏ö‡∏ö‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏â‡∏≤‡∏Å/‡∏î‡∏≠‡∏ô‡∏ñ‡∏±‡∏î‡πÑ‡∏õ‡∏Ç‡∏≠‡∏á‡∏ô‡∏¥‡∏¢‡∏≤‡∏¢ ‡πÇ‡∏î‡∏¢‡∏Ñ‡∏ß‡∏≤‡∏°‡∏Ç‡∏±‡∏î‡πÅ‡∏¢‡πâ‡∏á‡πÅ‡∏î‡πà‡∏•‡∏∞‡πÅ‡∏ö‡∏ö‡∏Ñ‡∏ß‡∏£‡∏°‡∏µ‡∏´‡∏±‡∏ß‡∏Ç‡πâ‡∏≠‡πÅ‡∏•‡∏∞‡∏Ñ‡∏≥‡∏≠‡∏ò‡∏¥‡∏ö‡∏≤‡∏¢ ‡∏™‡∏±‡πâ‡∏ô‡πÜ: ${notes ? `\n\n[‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏ï‡∏±‡∏ß‡∏•‡∏∞‡∏Ñ‡∏£/‡∏û‡∏•‡πá‡∏≠‡∏î]\n${notes}` : ""}`;

        // --- DOM Elements ---
        const mainAppContainer = document.getElementById('main-app-container');
        const loadingOverlay = document.getElementById('loading-overlay');
        const chatContainer = document.getElementById('chat-container');
        const userInput = document.getElementById('user-input');
        const sendButton = document.getElementById('send-button');
        const loadingIndicator = document.getElementById('loading-indicator');
        const modelSelector = document.getElementById('model-selector');
        const quickPromptContainer = document.querySelector('.quick-prompt-btn').parentElement;
        const userIdDisplay = document.getElementById('user-id-display');

        // API Key Elements
        const apiKeyInput = document.getElementById('api-key-input');
        const apiKeyLink = document.getElementById('api-key-link');

        // Modal Elements
        const notesModal = document.getElementById('notes-modal');
        const showNotesBtn = document.getElementById('show-notes');
        const closeModalBtn = document.getElementById('close-modal');
        const saveNotesBtn = document.getElementById('save-notes');
        const notesTextarea = document.getElementById('character-notes');

        // New Feature Elements
        const continuePlotBtn = document.getElementById('continue-plot-btn');
        const generateConflictBtn = document.getElementById('generate-conflict-btn'); // NEW
        const ttsBtn = document.getElementById('tts-btn');
        const ttsSelectedBtn = document.getElementById('tts-selected-btn');
        const audioPlayer = document.getElementById('audio-player');

        // Control Buttons
        const stopWritingBtn = document.getElementById('stop-writing-btn');
        const stopAudioBtn = document.getElementById('stop-audio-btn');
        const downloadAudioBtn = document.getElementById('download-audio-btn');

        // --- Streaming Control State ---
        let isStreaming = false;
        let streamTimeoutId = null;

        // --- Chat History ---
        let chatHistory = [];

        // --- Audio State ---
        let lastWavBlob = null;

        // --- User API Keys Storage ---
        let userApiKeys = {
            gemini: "",
            groq: "",
            deepseek: "",
            chatgpt: "",
            qwen: ""
        };

        // --- Model API Links ---
        const modelApiLinks = {
            gemini: 'https://aistudio.google.com/app/apikey',
            groq: 'https://console.groq.com/keys',
            deepseek: 'https://platform.deepseek.com/api_keys',
            chatgpt: 'https://platform.openai.com/api-keys',
            qwen: 'https://dashscope.console.aliyun.com/apiKey'
        };

        // --- ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô Utility ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö Retrying API Calls ---
        async function fetchWithRetry(url, options, retries = 3, delay = 1000) {
            for (let i = 0; i < retries; i++) {
                try {
                    const response = await fetch(url, options);
                    if (response.ok) {
                        return await response.json();
                    }
                    if (response.status === 400 && response.headers.get('content-type')?.includes('application/json')) {
                        const errorBody = await response.json();
                        throw new Error(`HTTP error! status: 400. Details: ${errorBody.error?.message || 'Unknown Bad Request.'}`);
                    }
                    if (response.status === 401 || response.status === 403) {
                        throw new Error(`HTTP error! status: ${response.status} (Invalid API Key)`);
                    }
                    throw new Error(`HTTP error! status: ${response.status}`);
                } catch (error) {
                    if (i === retries - 1) throw error;
                    await new Promise(resolve => setTimeout(resolve, delay * Math.pow(2, i)));
                }
            }
        }

        /**
         * [FIXED] Added complete function missing from PDF.
         * Converts base64 string to ArrayBuffer.
         */
        function base64ToArrayBuffer(base64) {
            const binaryString = atob(base64);
            const len = binaryString.length;
            const bytes = new Uint8Array(len);
            for (let i = 0; i < len; i++) {
                bytes[i] = binaryString.charCodeAt(i);
            }
            return bytes.buffer;
        }

        /**
         * Helper for pcmToWav
         */
        function writeString(view, offset, string) {
            for (let i = 0; i < string.length; i++) {
                view.setUint8(offset + i, string.charCodeAt(i));
            }
        }

        /**
         * [FIXED] Added complete function missing from PDF.
         * Converts raw PCM16 data to a WAV file Blob.
         */
        function pcmToWav(pcm16, sampleRate) {
            const numChannels = 1;
            const bytesPerSample = 2; // 16-bit
            const headerLength = 44;
            const buffer = new ArrayBuffer(headerLength + pcm16.length * bytesPerSample);
            const view = new DataView(buffer);

            // RIFF header
            writeString(view, 0, 'RIFF');
            view.setUint32(4, 36 + pcm16.length * bytesPerSample, true);
            writeString(view, 8, 'WAVE');

            // FMT sub-chunk
            writeString(view, 12, 'fmt ');
            view.setUint32(16, 16, true);
            view.setUint16(20, 1, true); // PCM format
            view.setUint16(22, numChannels, true);
            view.setUint32(24, sampleRate, true);
            view.setUint32(28, sampleRate * numChannels * bytesPerSample, true); // Byte rate
            view.setUint16(32, numChannels * bytesPerSample, true); // Block align
            view.setUint16(34, 16, true); // Bits per sample

            // Data sub-chunk
            writeString(view, 36, 'data');
            view.setUint32(40, pcm16.length * bytesPerSample, true);

            // Write PCM samples
            let offset = 44;
            for (let i = 0; i < pcm16.length; i++, offset += bytesPerSample) {
                view.setInt16(offset, pcm16[i], true);
            }

            return new Blob([view], {
                type: 'audio/wav'
            });
        }


        /**
         * [FIXED] Added Firebase initialization wrapper based on PDF code.
         */
        async function initFirebase() {
            const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
            let firebaseConfig;

            if (typeof __firebase_config !== 'undefined' && __firebase_config) {
                try {
                    firebaseConfig = JSON.parse(__firebase_config);
                } catch (e) {
                    console.error("Failed to parse Firebase config:", e);
                    loadingOverlay.querySelector('h2').textContent = '‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î';
                    loadingOverlay.querySelector('p').textContent = '‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡πÇ‡∏´‡∏•‡∏î‡∏Å‡∏≤‡∏£‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤ Firebase ‡πÑ‡∏î‡πâ';
                    initChat(); // Run in non-Firebase mode
                    return;
                }
            } else {
                console.warn("Firebase config not found. Running in non-Firebase mode.");
                loadingOverlay.querySelector('h2').textContent = '‡πÇ‡∏´‡∏°‡∏î‡∏™‡∏≤‡∏ò‡∏¥‡∏ï';
                loadingOverlay.querySelector('p').textContent = '‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠ Firebase';
                // This is the fallback path from the PDF
                initChat();
                return;
            }

            const app = initializeApp(firebaseConfig);
            auth = getAuth(app);
            db = getFirestore(app);
            setLogLevel('Debug'); // Enable Firebase logging

            onAuthStateChanged(auth, async (user) => {
                if (user) {
                    userId = user.uid;
                    userIdDisplay.textContent = `USER ID: ${userId}`;
                    userIdDisplay.classList.remove('hidden');
                } else {
                    // Try to sign in
                    try {
                        if (typeof __initial_auth_token !== 'undefined' && __initial_auth_token) {
                            await signInWithCustomToken(auth, __initial_auth_token);
                            // onAuthStateChanged will re-run
                        } else {
                            await signInAnonymously(auth);
                            // onAuthStateChanged will re-run
                        }
                    } catch (error) {
                        console.error("Authentication Error:", error);
                        // Fallback from PDF
                        userId = 'error-anon-' + Math.random().toString(36).substring(2, 9);
                        userIdDisplay.textContent = `ID (TEMP): ${userId}`;
                        userIdDisplay.classList.remove('hidden');
                    }
                }

                if (!isAuthReady && userId) { // Only start chat when auth is ready and we have a user
                    isAuthReady = true;
                    loadingOverlay.classList.add('hidden');
                    mainAppContainer.classList.remove('hidden');
                    // [FIXED] Added missing initChat() call for successful auth
                    initChat();
                }
            });
        }

        /**
         * ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡∏•‡∏á‡πÉ‡∏ô UI
         */
        function addMessageToUI(sender, text) {
            const bubble = document.createElement('div');
            bubble.className = sender === 'user' ? 'chat-bubble-user' : 'chat-bubble-ai';

            // ‡πÅ‡∏õ‡∏•‡∏á \n ‡πÄ‡∏õ‡πá‡∏ô <br> ‡πÅ‡∏•‡∏∞‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£ code blocks ‡∏´‡∏£‡∏∑‡∏≠ bold
            let formattedText = text
                .replace(/\n/g, '<br>')
                .replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>')
                .replace(/`(.*?)`/g, '<code class="bg-slate-200 text-red-600 px-1 rounded">$1</code>');

            bubble.innerHTML = formattedText;
            chatContainer.appendChild(bubble);
            autoScroll();
            return bubble;
        }

        /**
         * ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡∏™‡∏£‡∏∏‡∏õ‡∏à‡∏≤‡∏Å Grounding Search ‡∏•‡∏á‡πÉ‡∏ô UI
         */
        function addGroundingResponseToUI(text, sources) {
            const bubble = document.createElement('div');
            bubble.className = 'chat-bubble-ai bg-blue-50 border border-blue-200 text-slate-800'; // Special style

            let formattedText = text.replace(/\n/g, '<br>');

            if (sources && sources.length > 0) {
                formattedText += '<div class="grounding-sources"><strong>‡πÅ‡∏´‡∏•‡πà‡∏á‡∏≠‡πâ‡∏≤‡∏á‡∏≠‡∏¥‡∏á:</strong><ul>';
                sources.forEach((source, index) => {
                    formattedText += `<li>[${index + 1}] <a href="${source.uri}" target="_blank" rel="noopener noreferrer">${source.title}</a></li>`;
                });
                formattedText += '</ul></div>';
            }

            bubble.innerHTML = formattedText;
            chatContainer.appendChild(bubble);
            autoScroll();
            return bubble;
        }

        /**
         * ‡πÄ‡∏•‡∏∑‡πà‡∏≠‡∏ô‡∏´‡∏ô‡πâ‡∏≤‡∏à‡∏≠‡πÅ‡∏ä‡∏ó‡∏≠‡∏±‡∏ï‡πÇ‡∏ô‡∏°‡∏±‡∏ï‡∏¥
         */
        function autoScroll() {
            chatContainer.scrollTop = chatContainer.scrollHeight;
        }

        /**
         * ‡πÅ‡∏™‡∏î‡∏á/‡∏ã‡πà‡∏≠‡∏ô ‡∏ï‡∏±‡∏ß‡πÇ‡∏´‡∏•‡∏î
         */
        function showLoading(show) {
            loadingIndicator.style.display = show ? 'flex' : 'none';
        }

        /**
         * ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏Å‡∏≤‡∏£‡∏™‡∏ï‡∏£‡∏µ‡∏°‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏° (‡∏à‡∏≥‡∏•‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡∏û‡∏¥‡∏°‡∏û‡πå)
         */
        function startStreaming(text, bubble) {
            if (isStreaming) return;

            isStreaming = true;
            stopWritingBtn.disabled = false;

            const chars = text.split('');
            let currentText = '';
            let charIndex = 0;

            function appendChar() {
                if (!isStreaming || charIndex >= chars.length) {
                    stopStreaming(charIndex >= chars.length);
                    return;
                }

                currentText += chars[charIndex];
                bubble.innerHTML = currentText
                    .replace(/\n/g, '<br>')
                    .replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>')
                    .replace(/`(.*?)`/g, '<code class="bg-slate-200 text-red-600 px-1 rounded">$1</code>');

                charIndex++;
                autoScroll();
                streamTimeoutId = setTimeout(appendChar, 15); // ‡∏õ‡∏£‡∏±‡∏ö‡∏Ñ‡∏ß‡∏≤‡∏°‡πÄ‡∏£‡πá‡∏ß‡∏Å‡∏≤‡∏£‡∏û‡∏¥‡∏°‡∏û‡πå
            }
            appendChar();
        }

        /**
         * ‡∏´‡∏¢‡∏∏‡∏î‡∏Å‡∏≤‡∏£‡∏™‡∏ï‡∏£‡∏µ‡∏°‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°
         */
        function stopStreaming(completed = false) {
            if (!isStreaming) return;

            if (streamTimeoutId !== null) {
                clearTimeout(streamTimeoutId);
                streamTimeoutId = null;
            }

            isStreaming = false;
            stopWritingBtn.disabled = true;
            showLoading(false);

            if (!completed) {
                const lastBubble = chatContainer.lastChild;
                if (lastBubble && lastBubble.classList.contains('chat-bubble-ai')) {
                    const currentText = lastBubble.innerHTML;
                    if (!currentText.includes('[‡∏´‡∏¢‡∏∏‡∏î‡πÄ‡∏Ç‡∏µ‡∏¢‡∏ô‡πÇ‡∏î‡∏¢‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ]')) {
                        lastBubble.innerHTML += '... <span class="text-red-500 font-bold">[‡∏´‡∏¢‡∏∏‡∏î‡πÄ‡∏Ç‡∏µ‡∏¢‡∏ô‡πÇ‡∏î‡∏¢‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ]</span>';
                    }
                }
            }
        }

        // --- Core LLM & TTS Call Functions ---

        /**
         * ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏Ñ‡∏µ‡∏¢‡πå Gemini
         */
        function checkGeminiKey() {
            // [MODIFIED] Use Gemini key for all operations as other models aren't implemented
            const trimmedKey = userApiKeys.gemini.trim();
            if (!trimmedKey) {
                addMessageToUI('ai', '‡πÇ‡∏≠‡πä‡∏∞! ‡∏Ñ‡∏∏‡∏ì‡∏•‡∏∑‡∏°‡πÉ‡∏™‡πà API Key ‡∏Ç‡∏≠‡∏á Google Gemini ‡∏´‡∏£‡∏∑‡∏≠‡πÄ‡∏õ‡∏•‡πà‡∏≤‡∏Ñ‡∏£‡∏±‡∏ö? ‡πÑ‡∏õ‡∏ó‡∏µ‡πà‡∏°‡∏∏‡∏°‡∏ö‡∏ô‡∏Ç‡∏ß‡∏≤‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÉ‡∏™‡πà‡∏Ñ‡∏µ‡∏¢‡πå‡∏Å‡πà‡∏≠‡∏ô‡∏ô‡∏∞');
                return null;
            }
            return trimmedKey;
        }

        /**
         * ‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏Å‡∏≤‡∏£‡πÄ‡∏£‡∏µ‡∏¢‡∏Å LLM (Gemini)
         */
        async function handleLLMCall(promptToSend) {
            if (isStreaming) return;

            // 1. Get Key (Only Gemini is implemented in this file)
            const trimmedKey = checkGeminiKey();
            if (!trimmedKey) return;

            // Check for Grounding Search prefix and delegate
            if (promptToSend.startsWith(GROUNDING_PREFIX)) {
                const query = promptToSend.substring(GROUNDING_PREFIX.length).trim();
                await handleGroundingSearch(query);
                return;
            }

            // 2. Prepare UI and History
            showLoading(true);
            chatHistory.push({
                role: 'user',
                parts: [{
                    text: promptToSend
                }]
            });
            const apiHistory = chatHistory.slice(-10); // Use last 10 turns
            const payload = {
                contents: apiHistory,
                systemInstruction: {
                    parts: [{
                        text: SYSTEM_PROMPT
                    }]
                },
            };
            const DYNAMIC_API_URL = GEMINI_API_URL_BASE + trimmedKey;

            // 3. Call Gemini API
            try {
                const result = await fetchWithRetry(DYNAMIC_API_URL, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(payload)
                });

                const text = result?.candidates?.[0]?.content?.parts?.[0]?.text;
                if (text) {
                    chatHistory.push({
                        role: 'model',
                        parts: [{
                            text: text
                        }]
                    });
                    const bubble = addMessageToUI('ai', '');
                    startStreaming(text, bubble);
                    ttsBtn.disabled = false; // Enable TTS for this new message
                } else {
                    addMessageToUI('ai', '[ERROR: LLM Response Empty] ‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ‡∏£‡∏±‡∏ö‡∏Å‡∏≤‡∏£‡∏ï‡∏≠‡∏ö‡∏Å‡∏•‡∏±‡∏ö‡∏ó‡∏µ‡πà‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á');
                    ttsBtn.disabled = true;
                }
            } catch (error) {
                console.error("Error calling LLM API:", error);
                let displayError = error.message || "‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠‡∏Å‡∏±‡∏ö AI";
                if (displayError.includes('401') || displayError.includes('403')) {
                    displayError = "API Key ‡∏Ç‡∏≠‡∏á Gemini ‡πÑ‡∏°‡πà‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ‡∏£‡∏±‡∏ö‡∏≠‡∏ô‡∏∏‡∏ç‡∏≤‡∏ï ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏Ñ‡∏µ‡∏¢‡πå‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì";
                }
                addMessageToUI('ai', `[ERROR: LLM Call Failed] ${displayError}`);
                ttsBtn.disabled = true;
            } finally {
                showLoading(false);
                stopWritingBtn.disabled = true;
            }
        }

        /**
         * NEW: ‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏Å‡∏≤‡∏£‡πÄ‡∏£‡∏µ‡∏¢‡∏Å LLM ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏Ñ‡∏ß‡∏≤‡∏°‡∏Ç‡∏±‡∏î‡πÅ‡∏¢‡πâ‡∏á
         */
        async function handleConflictGeneration() {
            if (isStreaming) return;

            const trimmedKey = checkGeminiKey();
            if (!trimmedKey) return;

            const userPrompt = "‚ú® ‡∏™‡∏£‡πâ‡∏≤‡∏á 3 ‡∏Ñ‡∏ß‡∏≤‡∏°‡∏Ç‡∏±‡∏î‡πÅ‡∏¢‡πâ‡∏á ‚ú®";
            addMessageToUI('user', userPrompt);
            showLoading(true);

            // Use context from chat history AND notes
            const notes = notesTextarea.value;
            const conflictPrompt = CONFLICT_GENERATOR_PROMPT(notes);

            // Construct payload
            const apiHistory = chatHistory.slice(-10);
            const payload = {
                contents: [
                    ...apiHistory,
                    // Add the special conflict prompt
                    {
                        role: 'user',
                        parts: [{
                            text: conflictPrompt
                        }]
                    }
                ],
                systemInstruction: {
                    parts: [{
                        text: SYSTEM_PROMPT
                    }]
                },
            };

            const DYNAMIC_API_URL = GEMINI_API_URL_BASE + trimmedKey;

            try {
                const result = await fetchWithRetry(DYNAMIC_API_URL, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(payload)
                });

                const text = result?.candidates?.[0]?.content?.parts?.[0]?.text;

                if (text) {
                    chatHistory.push({
                        role: 'model',
                        parts: [{
                            text: text
                        }]
                    });
                    const bubble = addMessageToUI('ai', '');
                    startStreaming(text, bubble);
                    ttsBtn.disabled = false;
                } else {
                    addMessageToUI('ai', `[ERROR: ‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏Ñ‡∏ß‡∏≤‡∏°‡∏Ç‡∏±‡∏î‡πÅ‡∏¢‡πâ‡∏á‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à]`);
                }
            } catch (error) {
                console.error("Error calling Conflict Generator API:", error);
                addMessageToUI('ai', `[ERROR: Conflict Generator Failed] ${error.message}`);
            } finally {
                showLoading(false);
            }
        }

        /**
         * NEW: ‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏Å‡∏≤‡∏£‡πÄ‡∏£‡∏µ‡∏¢‡∏Å LLM ‡∏û‡∏£‡πâ‡∏≠‡∏° Google Search Grounding
         */
        async function handleGroundingSearch(userQuery) {
            if (isStreaming) return;

            const trimmedKey = checkGeminiKey();
            if (!trimmedKey) return;

            addMessageToUI('user', `${GROUNDING_PREFIX} ${userQuery}`);
            showLoading(true);

            const payload = {
                contents: [{
                    parts: [{
                        text: userQuery
                    }]
                }],
                tools: [{
                    "google_search": {}
                }],
                systemInstruction: {
                    parts: [{
                        text: GROUNDING_SYSTEM_PROMPT
                    }]
                },
            };

            const DYNAMIC_API_URL = GEMINI_API_URL_BASE + trimmedKey;

            try {
                const result = await fetchWithRetry(DYNAMIC_API_URL, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(payload)
                });

                const candidate = result.candidates?.[0];
                const text = candidate?.content?.parts?.[0]?.text;
                let sources = [];

                if (text) {
                    // Extract sources from grounding metadata
                    const groundingMetadata = candidate.groundingMetadata;
                    if (groundingMetadata && groundingMetadata.groundingAttributions) {
                        sources = groundingMetadata.groundingAttributions
                            .map(attribution => ({
                                uri: attribution.web?.uri,
                                title: attribution.web?.title,
                            }))
                            .filter(source => source.uri && source.title);
                    }

                    // Add to chat history (as a normal model response)
                    chatHistory.push({
                        role: 'model',
                        parts: [{
                            text: text
                        }]
                    });

                    // Add to UI with special formatting
                    addGroundingResponseToUI(text, sources);
                    ttsBtn.disabled = false;

                } else {
                    addMessageToUI('ai', `[ERROR: ‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏™‡∏£‡∏∏‡∏õ]`);
                    ttsBtn.disabled = true;
                }
            } catch (error) {
                console.error("Error calling Grounding API:", error);
                addMessageToUI('ai', `[ERROR: ‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à] ${error.message}`);
                ttsBtn.disabled = true;
            } finally {
                showLoading(false);
            }
        }


        /**
         * ‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏Å‡∏≤‡∏£‡πÄ‡∏£‡∏µ‡∏¢‡∏Å TTS (‡∏≠‡πà‡∏≤‡∏ô‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡∏•‡πà‡∏≤‡∏™‡∏∏‡∏î)
         */
        async function handleTTSCall() {
            const lastAiMessage = chatHistory.slice().reverse().find(msg => msg.role === 'model');

            if (!lastAiMessage) {
                addMessageToUI('ai', '‡∏≠‡πä‡∏∞! ‡∏ú‡∏°‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡∏•‡πà‡∏≤‡∏™‡∏∏‡∏î‡∏ó‡∏µ‡πà‡∏à‡∏∞‡∏≠‡πà‡∏≤‡∏ô‡πÉ‡∏´‡πâ‡∏ü‡∏±‡∏á‡πÄ‡∏•‡∏¢‡∏Ñ‡∏£‡∏±‡∏ö');
                return;
            }

            const textToSpeak = lastAiMessage.parts[0].text;
            const trimmedKey = checkGeminiKey();
            if (!trimmedKey) return;

            ttsBtn.disabled = true;
            ttsBtn.textContent = 'üéß ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏™‡∏£‡πâ‡∏≤‡∏á‡πÄ‡∏™‡∏µ‡∏¢‡∏á...';
            stopAudio();

            const DYNAMIC_TTS_URL = TTS_API_URL_BASE + trimmedKey;
            const payload = {
                contents: [{
                    parts: [{
                        text: `‡∏û‡∏π‡∏î‡∏î‡πâ‡∏ß‡∏¢‡∏ô‡πâ‡∏≥‡πÄ‡∏™‡∏µ‡∏¢‡∏á‡πÄ‡∏õ‡πá‡∏ô‡∏Å‡∏±‡∏ô‡πÄ‡∏≠‡∏á‡πÅ‡∏•‡∏∞‡∏ä‡∏±‡∏î‡πÄ‡∏à‡∏ô: ${textToSpeak}`
                    }]
                }],
                generationConfig: {
                    responseModalities: ["AUDIO"],
                    speechConfig: {
                        voiceConfig: {
                            prebuiltVoiceConfig: {
                                voiceName: "Kore"
                            }
                        }
                    }
                },
                model: TTS_MODEL_NAME
            };

            try {
                const result = await fetchWithRetry(DYNAMIC_TTS_URL, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(payload)
                });

                const part = result?.candidates?.[0]?.content?.parts?.[0];
                const audioData = part?.inlineData?.data;
                const mimeType = part?.inlineData?.mimeType;

                if (audioData && mimeType && mimeType.startsWith("audio/")) {
                    const sampleRateMatch = mimeType.match(/rate=(\d+)/);
                    const sampleRate = sampleRateMatch ? parseInt(sampleRateMatch[1], 10) : 24000;

                    const pcmData = base64ToArrayBuffer(audioData);
                    const pcm16 = new Int16Array(pcmData);
                    lastWavBlob = pcmToWav(pcm16, sampleRate);

                    const audioUrl = URL.createObjectURL(lastWavBlob);
                    audioPlayer.src = audioUrl;
                    audioPlayer.play();

                    stopAudioBtn.disabled = false;
                    downloadAudioBtn.disabled = false;

                } else {
                    throw new Error("Invalid TTS response structure.");
                }

            } catch (error) {
                console.error("Error calling TTS API:", error);
                addMessageToUI('ai', `[ERROR: ‡∏™‡∏£‡πâ‡∏≤‡∏á‡πÄ‡∏™‡∏µ‡∏¢‡∏á‡∏û‡∏π‡∏î‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à] ${error.message}`);
                ttsBtn.disabled = false;
            }
        }

        /**
         * NEW: ‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏Å‡∏≤‡∏£‡πÄ‡∏£‡∏µ‡∏¢‡∏Å TTS (‡∏≠‡πà‡∏≤‡∏ô‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡∏ó‡∏µ‡πà‡πÄ‡∏•‡∏∑‡∏≠‡∏Å)
         */
        async function handleTTSSelected() {
            const selectedText = window.getSelection().toString().trim();
            if (!selectedText) {
                addMessageToUI('ai', '‡∏Ñ‡∏∏‡∏ì‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡πÄ‡∏•‡∏¢‡∏Ñ‡∏£‡∏±‡∏ö ‡∏•‡∏≠‡∏á‡∏•‡∏≤‡∏Å‡πÄ‡∏°‡∏≤‡∏™‡πå‡∏Ñ‡∏•‡∏∏‡∏°‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡∏ó‡∏µ‡πà‡∏≠‡∏¢‡∏≤‡∏Å‡πÉ‡∏´‡πâ‡∏ú‡∏°‡∏≠‡πà‡∏≤‡∏ô‡∏™‡∏¥');
                return;
            }

            const trimmedKey = checkGeminiKey();
            if (!trimmedKey) return;

            ttsSelectedBtn.disabled = true;
            ttsSelectedBtn.textContent = 'üéß ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏™‡∏£‡πâ‡∏≤‡∏á‡πÄ‡∏™‡∏µ‡∏¢‡∏á...';
            stopAudio();

            const DYNAMIC_TTS_URL = TTS_API_URL_BASE + trimmedKey;
            const payload = {
                contents: [{
                    parts: [{
                        text: `‡∏û‡∏π‡∏î‡∏î‡πâ‡∏ß‡∏¢‡∏ô‡πâ‡∏≥‡πÄ‡∏™‡∏µ‡∏¢‡∏á‡πÄ‡∏õ‡πá‡∏ô‡∏Å‡∏±‡∏ô‡πÄ‡∏≠‡∏á‡πÅ‡∏•‡∏∞‡∏ä‡∏±‡∏î‡πÄ‡∏à‡∏ô: ${selectedText}`
                    }]
                }],
                generationConfig: {
                    responseModalities: ["AUDIO"],
                    speechConfig: {
                        voiceConfig: {
                            prebuiltVoiceConfig: {
                                voiceName: "Kore"
                            }
                        }
                    }
                },
                model: TTS_MODEL_NAME
            };

            try {
                const result = await fetchWithRetry(DYNAMIC_TTS_URL, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(payload)
                });

                const part = result?.candidates?.[0]?.content?.parts?.[0];
                const audioData = part?.inlineData?.data;
                const mimeType = part?.inlineData?.mimeType;

                if (audioData && mimeType && mimeType.startsWith("audio/")) {
                    const sampleRateMatch = mimeType.match(/rate=(\d+)/);
                    const sampleRate = sampleRateMatch ? parseInt(sampleRateMatch[1], 10) : 24000;

                    const pcmData = base64ToArrayBuffer(audioData);
                    const pcm16 = new Int16Array(pcmData);
                    lastWavBlob = pcmToWav(pcm16, sampleRate);

                    const audioUrl = URL.createObjectURL(lastWavBlob);
                    audioPlayer.src = audioUrl;
                    audioPlayer.play();

                    stopAudioBtn.disabled = false;
                    downloadAudioBtn.disabled = false;
                } else {
                    throw new Error("Invalid TTS response structure for selected text.");
                }
            } catch (error) {
                console.error("Error calling TTS API for selected text:", error);
                addMessageToUI('ai', `[ERROR: ‡∏™‡∏£‡πâ‡∏≤‡∏á‡πÄ‡∏™‡∏µ‡∏¢‡∏á‡∏û‡∏π‡∏î (‡∏ó‡∏µ‡πà‡πÄ‡∏•‡∏∑‡∏≠‡∏Å) ‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à] ${error.message}`);
            } finally {
                ttsSelectedBtn.disabled = false;
                ttsSelectedBtn.textContent = 'üéß ‡∏≠‡πà‡∏≤‡∏ô‡∏ó‡∏µ‡πà‡πÄ‡∏•‡∏∑‡∏≠‡∏Å';
            }
        }

        // --- Event Handlers & Initialization ---

        /**
         * ‡∏Å‡∏≥‡∏´‡∏ô‡∏î Event Listeners ‡πÅ‡∏•‡∏∞‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ï‡πâ‡∏ô‡∏Å‡∏≤‡∏£‡πÇ‡∏´‡∏•‡∏î
         */
        function initChat() {
            loadApiKeys();
            loadNotes();
            handleModelChange();

            // Input handling
            sendButton.addEventListener('click', handleUserInput);
            userInput.addEventListener('keydown', (e) => {
                if (e.key === 'Enter') {
                    handleUserInput();
                }
            });

            // Quick Prompts
            quickPromptContainer.querySelectorAll('.quick-prompt-btn').forEach(button => {
                button.addEventListener('click', (e) => handleQuickPrompt(e.target.textContent));
            });

            // Model & API Key Change handlers
            modelSelector.addEventListener('change', handleModelChange);
            apiKeyInput.addEventListener('input', saveApiKeys);

            // Modal Handlers
            showNotesBtn.addEventListener('click', () => notesModal.classList.remove('hidden'));
            closeModalBtn.addEventListener('click', () => notesModal.classList.add('hidden'));
            saveNotesBtn.addEventListener('click', saveNotes);

            // New Feature Handlers
            continuePlotBtn.addEventListener('click', handleContinuePlot);
            generateConflictBtn.addEventListener('click', handleConflictGeneration); // NEW
            ttsBtn.addEventListener('click', handleTTSCall);
            ttsSelectedBtn.addEventListener('click', handleTTSSelected); // NEW

            // Control Button Handlers
            stopWritingBtn.addEventListener('click', () => stopStreaming(false));
            stopAudioBtn.addEventListener('click', stopAudio);
            downloadAudioBtn.addEventListener('click', downloadAudio);

            // Audio Player Listeners
            audioPlayer.addEventListener('play', () => {
                ttsBtn.disabled = true;
                ttsSelectedBtn.disabled = true;
                stopAudioBtn.disabled = false;
            });

            audioPlayer.addEventListener('ended', () => {
                ttsBtn.disabled = false;
                ttsBtn.textContent = 'üéß ‡∏ü‡∏±‡∏á‡πÄ‡∏™‡∏µ‡∏¢‡∏á‡∏ï‡∏≠‡∏ö‡∏Å‡∏•‡∏±‡∏ö‡∏•‡πà‡∏≤‡∏™‡∏∏‡∏î';
                ttsSelectedBtn.disabled = false;
                ttsSelectedBtn.textContent = 'üéß ‡∏≠‡πà‡∏≤‡∏ô‡∏ó‡∏µ‡πà‡πÄ‡∏•‡∏∑‡∏≠‡∏Å';
                stopAudioBtn.disabled = true;
            });

            audioPlayer.addEventListener('pause', () => {
                ttsBtn.disabled = false;
                ttsBtn.textContent = 'üéß ‡∏ü‡∏±‡∏á‡πÄ‡∏™‡∏µ‡∏¢‡∏á‡∏ï‡∏≠‡∏ö‡∏Å‡∏•‡∏±‡∏ö‡∏•‡πà‡∏≤‡∏™‡∏∏‡∏î';
                ttsSelectedBtn.disabled = false;
                ttsSelectedBtn.textContent = 'üéß ‡∏≠‡πà‡∏≤‡∏ô‡∏ó‡∏µ‡πà‡πÄ‡∏•‡∏∑‡∏≠‡∏Å';
                stopAudioBtn.disabled = true;
            });
        }

        /**
         * ‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏Å‡∏≤‡∏£‡∏™‡πà‡∏á‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡∏Ç‡∏≠‡∏á‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ
         */
        function handleUserInput() {
            const promptText = userInput.value.trim();
            if (!promptText) return;

            userInput.value = '';

            // Delegate to the correct handler
            if (promptText.startsWith(GROUNDING_PREFIX)) {
                const query = promptText.substring(GROUNDING_PREFIX.length).trim();
                handleGroundingSearch(query);
            } else {
                addMessageToUI('user', promptText);
                handleLLMCall(promptText);
            }
        }

        /**
         * ‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏Å‡∏≤‡∏£‡∏Ñ‡∏•‡∏¥‡∏Å Quick Prompt
         */
        function handleQuickPrompt(promptText) {
            if (isStreaming) return;

            // Check if it's a grounding query
            if (promptText.startsWith(GROUNDING_PREFIX)) {
                const query = promptText.substring(GROUNDING_PREFIX.length).trim();
                handleGroundingSearch(query);
            } else {
                addMessageToUI('user', promptText);
                handleLLMCall(promptText);
            }
        }

        /**
         * ‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏Å‡∏≤‡∏£‡∏Ñ‡∏•‡∏¥‡∏Å "‡πÄ‡∏Ç‡∏µ‡∏¢‡∏ô‡∏ï‡πà‡∏≠"
         */
        function handleContinuePlot() {
            if (isStreaming) return;
            const promptText = "‡πÄ‡∏Ç‡∏µ‡∏¢‡∏ô‡∏ï‡πà‡∏≠‡∏à‡∏≤‡∏Å‡∏ô‡∏µ‡πâ";
            addMessageToUI('user', promptText);
            handleLLMCall(promptText);
        }

        /**
         * ‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï UI ‡πÄ‡∏°‡∏∑‡πà‡∏≠‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô Model
         */
        function handleModelChange() {
            const selectedModel = modelSelector.value;
            apiKeyInput.placeholder = `‡πÉ‡∏™‡πà API Key ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö ${modelSelector.options[modelSelector.selectedIndex].text}`;
            apiKeyInput.value = userApiKeys[selectedModel] || '';
            apiKeyLink.href = modelApiLinks[selectedModel];

            // [MODIFIED] Disable buttons if not Gemini, as others are not implemented
            const isGemini = selectedModel === 'gemini';
            const buttons = [
                sendButton, continuePlotBtn, generateConflictBtn,
                ttsBtn, ttsSelectedBtn, stopAudioBtn, downloadAudioBtn,
                ...quickPromptContainer.querySelectorAll('.quick-prompt-btn')
            ];

            if (isGemini) {
                buttons.forEach(btn => btn.disabled = false);
                // Re-enable TTS button only if there is a last message
                if (chatHistory.slice().reverse().find(msg => msg.role === 'model')) {
                    ttsBtn.disabled = false;
                } else {
                    ttsBtn.disabled = true;
                }
            } else {
                buttons.forEach(btn => btn.disabled = true);
                addMessageToUI('ai', `‡∏Ç‡∏≠‡∏≠‡∏†‡∏±‡∏¢‡∏Ñ‡∏£‡∏±‡∏ö ‡πÉ‡∏ô‡πÑ‡∏ü‡∏•‡πå‡πÇ‡∏Ñ‡πâ‡∏î‡∏ô‡∏µ‡πâ‡∏°‡∏µ‡∏Å‡∏≤‡∏£ œÖŒªŒø h√≥a (implement) ‡πÄ‡∏â‡∏û‡∏≤‡∏∞ Google Gemini ‡πÄ‡∏ó‡πà‡∏≤‡∏ô‡∏±‡πâ‡∏ô‡∏Ñ‡∏£‡∏±‡∏ö`);
            }
        }


        /**
         * ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å API Keys ‡∏•‡∏á‡πÉ‡∏ô object ‡πÅ‡∏•‡∏∞ localStorage
         */
        function saveApiKeys() {
            const selectedModel = modelSelector.value;
            userApiKeys[selectedModel] = apiKeyInput.value.trim();
            try {
                localStorage.setItem('userApiKeys', JSON.stringify(userApiKeys));
            } catch (e) {
                console.warn("Could not save API keys to localStorage:", e);
            }
        }

        /**
         * ‡πÇ‡∏´‡∏•‡∏î API Keys ‡∏à‡∏≤‡∏Å localStorage
         */
        function loadApiKeys() {
            try {
                const savedKeys = localStorage.getItem('userApiKeys');
                if (savedKeys) {
                    userApiKeys = JSON.parse(savedKeys);
                }
            } catch (e) {
                console.warn("Could not load API keys from localStorage:", e);
            }
        }

        /**
         * ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å Notes
         */
        function saveNotes() {
            try {
                localStorage.setItem('characterNotes', notesTextarea.value);
                notesModal.classList.add('hidden');
            } catch (e) {
                console.warn("Could not save notes to localStorage:", e);
                addMessageToUI('ai', '[ERROR: ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÇ‡∏ô‡πâ‡∏ï‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à ‡∏û‡∏∑‡πâ‡∏ô‡∏ó‡∏µ‡πà‡∏≠‡∏≤‡∏à‡∏à‡∏∞‡πÄ‡∏ï‡πá‡∏°]');
            }
        }

        /**
         * ‡πÇ‡∏´‡∏•‡∏î Notes
         */
        function loadNotes() {
            try {
                const savedNotes = localStorage.getItem('characterNotes');
                if (savedNotes) {
                    notesTextarea.value = savedNotes;
                }
            } catch (e) {
                console.warn("Could not load notes from localStorage:", e);
            }
        }

        /**
         * ‡∏´‡∏¢‡∏∏‡∏î‡πÄ‡∏•‡πà‡∏ô‡πÄ‡∏™‡∏µ‡∏¢‡∏á
         */
        function stopAudio() {
            if (!audioPlayer.paused) {
                audioPlayer.pause();
                audioPlayer.currentTime = 0;
            }
            stopAudioBtn.disabled = true;
            ttsBtn.disabled = false; // Re-enable main TTS btn
            ttsSelectedBtn.disabled = false; // Re-enable selected TTS btn
        }

        /**
         * ‡∏î‡∏≤‡∏ß‡∏ô‡πå‡πÇ‡∏´‡∏•‡∏î‡πÑ‡∏ü‡∏•‡πå‡πÄ‡∏™‡∏µ‡∏¢‡∏á
         */
        function downloadAudio() {
            if (!lastWavBlob) {
                addMessageToUI('ai', '‡∏≠‡πä‡∏∞! ‡πÑ‡∏°‡πà‡∏°‡∏µ‡πÑ‡∏ü‡∏•‡πå‡πÄ‡∏™‡∏µ‡∏¢‡∏á‡πÉ‡∏´‡πâ‡∏î‡∏≤‡∏ß‡∏ô‡πå‡πÇ‡∏´‡∏•‡∏î‡∏Ñ‡∏£‡∏±‡∏ö ‡∏•‡∏≠‡∏á‡∏Å‡∏î "‡∏ü‡∏±‡∏á‡πÄ‡∏™‡∏µ‡∏¢‡∏á" ‡∏Å‡πà‡∏≠‡∏ô‡∏ô‡∏∞');
                return;
            }
            const url = URL.createObjectURL(lastWavBlob);
            const a = document.createElement('a');
            a.style.display = 'none';
            a.href = url;
            a.download = 'phu-kan-ngoen-audio.wav';
            document.body.appendChild(a);
            a.click();
            window.URL.revokeObjectURL(url);
            document.body.removeChild(a);
        }

        // --- ‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ï‡πâ‡∏ô‡πÅ‡∏≠‡∏õ ---
        initFirebase();
    </script>
</body>

</html>
